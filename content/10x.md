Title: 10x engineer - c·∫Øt gi·∫£m chi ph√≠ 10 l·∫ßn
Date: 2021-06-30
Category: Trang ch·ªß
Tags: python, regex, lambda, kafka, profile, cprofile
Slug: 10x
Authors: hvnsweeting
Summary: v·ªõi regex, lambda, kafka - nh·ªù h·ªçc h√†nh Python t·ª≠ t·∫ø

## Huy·ªÅn tho·∫°i 3x 4x 5x ... 10x (xxxxxxxxxx)

10x engineer l√† m·ªôt huy·ªÅn tho·∫°i (myth) l√¢u ƒë·ªùi trong gi·ªõi IT, m∆° t∆∞·ªüng v·ªÅ
1 developer c√≥ kh·∫£ nƒÉng code "h∆°n" ng∆∞·ªùi b√¨nh th∆∞·ªùng 10 l·∫ßn (ho·∫∑c h∆°n).
V√¨ l√† "myth", n√™n c√≥ ng∆∞·ªùi tin, c√≥ ng∆∞·ªùi kh√¥ng.

[![The Myth](https://img.youtube.com/vi/QoVeAANfESY/0.jpg)](https://youtu.be/QoVeAANfESY)


Vi·ªác l√™n internet t√¨m ki·∫øm 10x engineer tr√™n th·∫ø gi·ªõi kh√¥ng qu√° kh√≥ khƒÉn, nh∆∞ng
g·∫∑p khi ƒëi l√†m ngo√†i th·ª±c t·∫ø l√† chuy·ªán kh√¥ng nhi·ªÅu.
10x th·∫ø gi·ªõi t·∫°m k·ªÉ:

- [Linus Torvard](https://en.wikipedia.org/wiki/Linus_Torvalds) - t√°c gi·∫£ Linux, git
- [Fabrice Bellard](https://en.wikipedia.org/wiki/Fabrice_Bellard) - t√°c gi·∫£ FFmpeg, QEMU, tiny C compiler (tcc), quickJS
- [John Carmack](https://en.wikipedia.org/wiki/John_Carmack) - t√°c gi·∫£ game Doom, Quake
- [Peter Norvig](https://norvig.com/) - Director of Research Google
- [Antirez](http://antirez.com/latest/0) - t√°c gi·∫£ redis, hping


nh·ªØng v√≠ d·ª• tr√™n ch·ªâ ph·ª•c v·ª• m·ª•c ƒë√≠ch d·ªÖ h√¨nh dung, b·ªüi h·ªç thu·ªôc c·ª° 100 hay 1000x
ch·ª© kh√¥ng ph·∫£i 10x.
B√≠ quy·∫øt l√† g√¨ kh√¥ng r√µ, nh∆∞ng ƒëi·ªÉm chung: h·ªç ƒë·ªÅu ƒë√£ ngo√†i 40 v√† d√†nh h∆°n n·ª≠a
cu·ªôc ƒë·ªùi l√†m software. Kh√¥ng c√≥ ai 30 ƒë√£ v·ªÅ ngh·ªâ hay l√™n l√†m manager c·∫£. 

Ti√™u ch√≠ 10x kh√¥ng r√µ r√†ng, v√¨ ƒë√¢y l√† "myth", n√™n m·ªói ng∆∞·ªùi nghƒ© theo
1 ki·ªÉu. Theo m·ªôt ti√™u ch√≠ v√≠ d·ª•, mrX g√µ nhanh h∆°n mrY 10 l·∫ßn, n√™n c≈©ng c√≥ khi
ƒë∆∞·ª£c g·ªçi l√† 10x engineer.

B√†i vi·∫øt n√†y kh√¥ng li√™n quan t·ªõi chuy·ªán c√°c 10x n√≥i tr√™n, m√† ƒë∆°n gi·∫£n ch·ªâ l√†
ti·∫øt ki·ªám 10x chi ph√≠ ch·∫°y code Python, nh·ªù ƒë∆∞·ª£c h·ªçc Python "t·ª≠ t·∫ø".

## V√≠ d·ª•
Sinh ra 1 file .log.gz v√≠ d·ª• ch·ª©a 1_500_000 d√≤ng (t·ª´ 3 d√≤ng l·∫∑p ƒëi l·∫∑p l·∫°i)

```py
import gzip

lines = [
    'http 2015-05-13T23:39:43.945958Z my-loadbalancer 192.168.131.39:2817 10.0.0.1:80 0.000073 0.001048 0.000057 200 200 0 29 "GET http://www.example.com:80/index HTTP/1.1" "curl/7.38.0" - - arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/my-targets/73e2d6bc24d8a067 "Root=1-58337262-36d228ad5d99923122bbe354"',
    'https 2015-05-13T23:39:43.945958Z my-loadbalancer 192.168.131.39:2817 10.0.0.1:80 0.000086 0.001048 0.001337 200 200 0 57 "GET https://mytest-111.ap-northeast-1.elb.amazonaws.com:443/p/a/t/h?foo=bar&hoge=fuga HTTP/1.1" "curl/7.38.0" DHE-RSA-AES128-SHA TLSv1.2 arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/my-targets/73e2d6bc24d8a067 "Root=1-58337262-36d228ad5d99923122bbe354"',
    'https 2015-05-13T23:39:43.945958Z my-loadbalancer 192.168.131.39:2817 10.0.0.1:80 0.000086 0.001048 0.001337 200 200 0 57 "GET https://mytest-111.ap-northeast-1.elb.amazonaws.com:443/p/a/t/h?foo=bar&hoge=fuga:904abc HTTP/1.1" "curl/7.38.0" DHE-RSA-AES128-SHA TLSv1.2 arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/my-targets/73e2d6bc24d8a067 "Root=1-58337262-36d228ad5d99923122bbe354"',
]
with gzip.open("bigfile.log.gz", "wb") as fout:
    i = 0
    while i < 1_500_000:
        line = lines[i % len(lines)] + "\n"
        fout.write(line.encode('utf-8'))
        i = i + 1
```

File n√†y c√≥ k√≠ch th∆∞·ªõc kh√° nh·ªè (<10MB)

```
$ python makelog.py; ls -la bigfile.log.gz
-rw-rw-r-- 1 hvn hvn 2960897 Jun 30 22:42 bigfile.log.gz
$ gunzip bigfile.log.gz; wc -l bigfile.log; ls -l bigfile.log
1500000 bigfile.log
-rw-rw-r-- 1 hvn hvn 559000000 Jun 30 22:42 bigfile.log
$ ls -lh bigfile.log
-rw-rw-r-- 1 hvn hvn 534M Jun 30 22:42 bigfile.log

```
nh∆∞ng khi gi·∫£i n√©n, k√≠ch th∆∞·ªõc l·ªõn h∆°n r·∫•t nhi·ªÅu l·∫ßn
(do d·ªØ li·ªáu tr√πng l·∫∑p nhi·ªÅu n√™n n√©n l·∫°i t·ª´ to th√†nh r·∫•t nh·ªè).

ƒê√¢y l√† ƒëo·∫°n code ban ƒë·∫ßu, n√≥ ƒë·ªçc c√°c d√≤ng text t·ª´ 1 file c√≥ ƒëu√¥i `.log.gz` ra,
r·ªìi g·ª≠i ƒë·∫øn 1 ch·ªó kh√°c. H√£y xem k·ªπ xem b·∫°n c√≥
th·ªÉ "t·ªëi ∆∞u" ƒë∆∞·ª£c bao nhi√™u b∆∞·ªõc v√† tr·ªü th√†nh m·∫•y x t·ª´ ƒë√¢y?

Code albv1.py

```py
import gzip

i = 0
with gzip.open("bigfile.log.gz", "rt") as f:
    for line in f.readlines():
        i = i + 1
        if i == 10:
            break

print("Proceeded {} lines".format(i))
```
File n√©n c√≥ ƒëu√¥i `.gz` ƒë∆∞·ª£c t·∫°o b·ªüi c√°c ch∆∞∆°ng tr√¨nh `gzip`, b√™n d∆∞·ªõi d√πng
th∆∞ vi·ªán [`zlib`](https://www.zlib.net/).
[Th∆∞ vi·ªán `gzip` c·ªßa Python](https://docs.python.org/3/library/gzip.html)
cho ph√©p m·ªü file .gz nh∆∞ file text b√¨nh th∆∞·ªùng,
n√≥ th·ª±c hi·ªán gi·∫£i n√©n ph√≠a sau b·ª©c m√†n b√≠ m·∫≠t. Mode m·ªü file `rt` gi√∫p lib gzip
hi·ªÉu ta mu·ªën thu ƒë∆∞·ª£c `str` sau khi gi·∫£i n√©n, c√≤n khi m·∫∑c ƒë·ªãnh n√≥ m·ªü ·ªü mode `rb`, tr·∫£
v·ªÅ ki·ªÉu `bytes`. Ch·∫°y ƒëo·∫°n code tr√™n, s·ª≠ d·ª•ng
`/usr/bin/time -v` ƒë·ªÉ ƒëo th·ªùi gian ch·∫°y v√† c√°c th√¥ng s·ªë chi ti·∫øt v·ªÅ b·ªô nh·ªõ max.
(tr√™n MacOS d√πng -l)

```sh
$ /usr/bin/time -v python3 albv1.py
Proceeded 10 lines
    ...
	Maximum resident set size (kbytes): 693652
    ...

```

Code n√†y d√πng ~ 600 MB RAM.

Sau khi thay ƒë·ªïi, code ch·ªâ c√≤n d√πng ~ 9MB RAM

```sh
$ /usr/bin/time -v python3 albv2.py
Proceeded 10 lines
    ...
	Maximum resident set size (kbytes): 9752
    ...

```

Ch·ªâ thay ƒë·ªïi duy nh·∫•t 1 d√≤ng:
```
$ diff albv1.py albv2.py
12c12
<     for line in f.readlines():
---
>     for line in f:

```

ƒêi·ªÅu n√†y b·∫•t k·ª≥ h·ªçc vi√™n [Pymi.vn](https://pymi.vn/) n√†o c≈©ng ph√°t hi·ªán ra
ngay, b·ªüi trong h·ªá th·ªëng b√†i t·∫≠p ƒë√£ c√≥ 1 b√†i x·ª≠ l√Ω file 30 tri·ªáu d√≤ng n·∫∑ng h∆°n
500 MB t∆∞∆°ng t·ª±. C√°ch x·ª≠ l√Ω t·ª´ng d√≤ng m·ªôt:

```py
for line in f:
```

m√† kh√¥ng d√πng `f.readlines()` hay `f.read()`, v√¨ ch√∫ng ƒë·ªçc to√†n b·ªô n·ªôi dung
file t·ª´ ·ªï c·ª©ng v√†o RAM.
Ch√∫ √Ω c·∫£ s·ª± ch√™nh l·ªách, Python ƒë·ªçc file text 534MB v√†o th√†nh 670MB RAM.

"B√≠ k√≠p" ƒë·ªçc file theo d√≤ng n√†y d√π ch·∫≥ng c√≥ g√¨ ƒë·∫∑c bi·ªát, ghi r√µ trong t√†i li·ªáu
trang ch·ªß nh∆∞ng l·∫°i tr·ªü th√†nh chuy·ªán l·∫° v·ªõi h√†ng ng√†n b√†i h∆∞·ªõng d·∫´n tr√™n m·∫°ng,
th·∫≠m ch√≠ c·∫£ s√°ch c≈©ng d·∫°y d√πng readlines.
H√£y th·ª≠ [search
github](https://github.com/search?q=%22readlines%22+language%3APython&type=Code)
c√≥ t·ªõi h∆°n 2 tri·ªáu k·∫øt qu·∫£, d√π cho github kh√¥ng search ch√≠nh x√°c ƒë∆∞·ª£c, th√¨
chuy·ªán n√†y v·∫´n kh√¥ng ph·∫£i l√† hi·∫øm.

Search [StackOverFlow python read file into list](https://stackoverflow.com/questions/3925614/how-do-you-read-a-file-into-a-list-in-python), tr·∫£ v·ªÅ h√†ng lo·∫°t k·∫øt qu·∫£ c≈©ng kh√¥ng ·ªïn t√≠ n√†o.

`readlines` hay `read` ho√†n to√†n ok khi l·∫≠p tr√¨nh vi√™n l√†m ch·ªß ƒë∆∞·ª£c k√≠ch th∆∞·ªõc
file ƒë·∫ßu v√†o (file c·ªë ƒë·ªãnh, file ƒë∆∞·ª£c cam k·∫øt l√† nh·ªè), nh∆∞ng khi file c√≥ size
t·ªõi h√†ng
MB, n√≥ s·∫Ω chi·∫øm kh√¥ng √≠t RAM ƒë·ªÉ ch·∫°y ch∆∞∆°ng tr√¨nh.

Phi√™n b·∫£n `v2` c√≥ th·ªÉ x·ª≠ l√Ω file c√≥ k√≠ch th∆∞·ªõc l·ªõn t√πy √Ω, 10GB, 100GB, ƒë·ªÅu v·∫´n
ch·ªâ d√πng < 10MB (v·ªõi gi·∫£ thi·∫øt k√≠ch th∆∞·ªõc m·ªói d√≤ng kh√¥ng qu√° kh√°c bi·ªát).

V·∫≠y ch·ªâ c·∫ßn ƒë∆∞·ª£c h·ªçc Python t·ª≠ t·∫ø, ƒë√£ tr·ªü th√†nh 10x r·ªìi.

### ƒê·ªô ƒëo
ƒê·ªÉ t√≠nh m·∫•y x cho r√µ r√†ng, b√†i n√†y s·∫Ω s·ª≠ d·ª•ng ƒë∆°n v·ªã ƒëo m√† lo√†i ng∆∞·ªùi ∆∞a chu·ªông nh·∫•t: ti·ªÅn.

T√≠nh ti·ªÅn 1 ch∆∞∆°ng tr√¨nh trong 1 c√°i m√°y th√¨ kh√° kh√≥, nh∆∞ng ng√†y nay, khi
"cloud computing" l√† th·ªùi th∆∞·ª£ng, ch·∫°y code tr√™n [AWS lambda](https://www.familug.org/2017/08/serverless.html)
gi√∫p chuy·ªán t√≠nh ti·ªÅn d·ªÖ nh∆∞ h·ªçc
to√°n c·∫•p 1. Xem [AWS Lambda pricing](https://aws.amazon.com/lambda/pricing/)

Theo th·ª≠ nghi·ªám tr√™n m√°y, hai phi√™n b·∫£n v1 v√† v2 ch·∫°y v·ªÅ t·ªëc ƒë·ªô l√† nh∆∞ nhau
(ho·∫∑c ch√™nh 1 2 3 gi√¢y tr√™n t·ªïng 60s kh√¥ng ƒë√°ng k·ªÉ),
th√¨ ph·∫ßn c√≤n l·∫°i c·ªßa bi·ªÉu th·ª©c ph·ª• thu·ªôc v√†o l∆∞·ª£ng RAM s·ª≠ d·ª•ng.
N√≥i ƒë∆°n gi·∫£n th√¨ RAM c·∫•u h√¨nh cho Lambda function bao nhi√™u, th√¨ gi√° g·∫•p b·∫•y nhi√™u.
Code ƒëƒÉng k√Ω d√πng 256 MB RAM s·∫Ω ƒë·∫Øt g·∫•p ƒë√¥i code ƒëƒÉng k√Ω 128MB.
V·ªõi v√≠ d·ª• trong b√†i, m·ªói file log k√≠ch th∆∞·ªõc c·ª° 300-600 MB, l·∫≠p tr√¨nh vi√™n s·∫Ω th∆∞·ªùng
ƒë·ªÉ m·ª©c an to√†n l√† 1024MB (1GB) tr√°nh t√¨nh tr·∫°ng c√≥ file 800MB xu·∫•t hi·ªán m√† thi·∫øu RAM.

Code v2 lu√¥n d√πng 10MB RAM (=> 100x), nh∆∞ng m·ª©c t·ªëi thi·ªÉu AWS Lambda cho ph√©p l√†
128MB, v·∫≠y ·ªü ƒë√¢y ti·∫øt ki·ªám 8 l·∫ßn => 8x.

**C√∫ twist gi·∫≠t m√¨nh**: c√¢u chuy·ªán th·ª±c ra kh√¥ng ƒë∆°n gi·∫£n v·∫≠y, v·ªõi nhi·ªÅu RAM h∆°n,
AWS Lambda s·∫Ω c·∫•p th√™m
"nƒÉng l∆∞·ª£ng" cho CPU t·ª∑ l·ªá v·ªõi RAM, trong v√≠ d·ª• n√†y, n·∫øu h·∫ßu h·∫øt th·ªùi gian
ch∆∞∆°ng tr√¨nh ƒë·ªÅu ƒë·ªÉ d√πng CPU, gi·∫£m 8x RAM ƒëƒÉng k√Ω ƒë·ªìng nghƒ©a v·ªõi gi·∫£m t·ªëc ƒë·ªô CPU 8 l·∫ßn.
Hay k·∫øt qu·∫£ l√† v2 ch·∫°y m·∫•t 8s x 128MB th√¨ v1 ch·∫°y m·∫•t 1s x 1024 MB, v√† gi√° ti·ªÅn l√† nh∆∞ nhau.

> Lambda allocates CPU power in proportion to the amount of memory configured.
> Memory is the amount of memory available to your Lambda function at runtime.
> You can increase or decrease the memory and CPU power allocated to your
> function using the Memory (MB) setting. To configure the memory for your
> function, set a value between 128 MB and 10,240 MB in 1-MB increments. At
> 1,769 MB, a function has the equivalent of one vCPU (one vCPU-second of
> credits per second).

https://docs.aws.amazon.com/lambda/latest/dg/configuration-memory.html

V·ªõi ƒëo·∫°n ch√∫ √Ω n√†y, n·∫øu function ch·ªâ s·ª≠ d·ª•ng 1 core (code kh√¥ng s·ª≠ d·ª•ng th∆∞ vi·ªán
multiprocess), t·ªëc ƒë·ªô CPU c·ªßa n√≥ ƒë·∫°t t·ªëi
ƒëa khi c·∫•u h√¨nh 1769MB, d√π c√≥ tƒÉng RAM l√™n 2048MB th√¨ ch·ªâ tƒÉng th√™m 1 core n·ªØa
ch·ª© kh√¥ng l√†m core ban ƒë·∫ßu m·∫°nh l√™n, hay n√≥i c√°ch kh√°c: kh√¥ng l√†m code ch·∫°y nhanh
h∆°n.

PS: trong m√¥i tr∆∞·ªùng l∆∞·ª£ng CPU l√† c·ªë ƒë·ªãnh (m√°y ·∫£o, m√°y v·∫≠t l√Ω...), v2 v·∫´n l√† 100x.

**C√∫ twist s·ªë 2**: vi·ªác t√≠nh ti·ªÅn tr√™n c√°c h·ªá th·ªëng cloud kh√¥ng h·ªÅ ƒë∆°n gi·∫£n,
c√≥ h√†ng ng√†n d·ªãch v·ª• [cung c·∫•p gi·∫£i ph√°p ph√¢n t√≠ch, ƒë·ªçc hi·ªÉu, t·ªëi ∆∞u code cloud](https://www.lastweekinaws.com/).
Hay m·ªçc c·∫£ ra ngh·ªÅ [FinOps](https://www.finops.org/introduction/what-is-finops/)
chuy√™n v·ªÅ t·ªëi ∆∞u h√≥a [cloud cost](https://aws.amazon.com/blogs/enterprise-strategy/introducing-finops-excuse-me-devsecfinbizops/),
ng√†nh kinh t·∫ø tr√™n m√¢y (cloud economics) v·ªõi c√°c chuy√™n gia c√≥ ngh·ªá danh "cloud economist".

**K·∫øt lu·∫≠n 1:** 100x l√† c√≥ th·∫≠t, nh∆∞ng c√≤n ph·ª• thu·ªôc v√†o ho√†n c·∫£nh, kh√¥ng n·∫±m ngo√†i
"thuy·∫øt t∆∞∆°ng ƒë·ªëi".
Vi·ªác gi·∫£m 8x RAM ·ªü ƒë√¢y kh√¥ng l√†m gi·∫£m chi ph√≠, c√¥ng vi·ªác ti·∫øp theo l√† c·∫Øt gi·∫£m
chi ph√≠ b·∫±ng c√°ch tƒÉng t·ªëc code.

## TƒÉng t·ªëc regex
Phi√™n b·∫£n sau th√™m c√¥ng ƒëo·∫°n x·ª≠ l√Ω t·ª´ng d√≤ng ƒë·ªÉ l·ªçc ra c√°c gi√° tr·ªã mong
mu·ªën, s·ª≠ d·ª•ng c√¥ng c·ª•: ["regular expression"](https://docs.python.org/3/howto/regex.html) - hay g·ªçi ng·∫Øn l√† **regex**.
B·∫°n ƒë·ªçc kh√¥ng n√™n qu√° t·∫≠p trung hay s·ª£ h√£i khi nh√¨n v√†o ph·∫ßn "pattern" vi·∫øt ƒë·ªëng giun d·∫ø g√¨, v√¨
kh√¥ng nhi·ªÅu ng∆∞·ªùi c√≥ kh·∫£ nƒÉng ƒë·ªçc, hi·ªÉu, ph√¢n t√≠ch ƒëo·∫°n n√†y, k·ªÉ c·∫£ c√≥
10 nƒÉm ƒëi code hay l√†m sysadmin. Code regex th∆∞·ªùng kh√≥ ƒë·ªçc kh√≥ hi·ªÉu,
khi c·∫ßn d√πng ch·ªß y·∫øu c√°c l·∫≠p tr√¨nh vi√™n ƒëi copy, ƒëo·∫°n b√™n d∆∞·ªõi c≈©ng l√†
copy t·ª´ link trong comment.

```
import gzip
import regex

# copied and edited from https://gist.github.com/szinck/d456fbf691483ab77d2453c316db3371
pattern = '(.*?) (.*?) (.*?) ([0-9.]+):([0-9]*) ([0-9.]+):([0-9]*) ([.0-9]*) ([.0-9]*) ([.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) "(.*?) .*:([0-9]+)([^? ]*)(\\x3f?.*?) (.*?)" "(.*?)" (.*?) (.*?) (.*?) "(.*?)" *$'
# example in AWS docs does not work directly with python https://docs.aws.amazon.com/athena/latest/ug/application-load-balancer-logs.html

p = re.compile(pattern)

i = 0
with gzip.open("bigfile.log.gz", "rt") as f:
    for line in f.readlines():
        i = i + 1
        m = p.match(line)
        if m:
            result = " ".join(m.group(17, 11))
            # print("sending", result)
        if i == 10:
            break

print("Proceeded {} lines".format(i))
```

Kh√¥ng hi·ªÉu g√¨ th√¨ l√†m sao m√† tƒÉng t·ªëc?

### H·ªçc regex trong 7 ph√∫t
7 ph√∫t ƒë·ªß ƒë·ªÉ qu√°n bia l√†m xong m√≥n "gi√≤ n√≥ng 7 ph√∫t".
Trong 7 ph√∫t ƒë·ªß ƒë·ªÉ b·∫°n c√≥ ki·∫øn th·ª©c regex b·∫±ng v·ªõi 90% l·∫≠p tr√¨nh vi√™n tr√™n th·∫ø
gi·ªõi.

#### regex l√† g√¨
regex l√† m·ªôt ng√¥n ng·ªØ d√πng ƒë·ªÉ m√¥ t·∫£ pattern (ti·∫øng Vi·ªát hay d·ªãch l√† d·∫°ng, m·∫´u)
c·ªßa 1 gi√° tr·ªã.
V√≠ d·ª•: m·ªôt s·ªë ƒëi·ªán tho·∫°i di ƒë·ªông ·ªü Vi·ªát Nam l√† m·ªôt s·ªë c√≥ 10 hay 11 ch·ªØ s·ªë.
C√°c pattern sau s·∫Ω "match" (kh·ªõp m·∫´u) s·ªë ƒëi·ªán tho·∫°i:

- `\d+`
- `[0-9]+`

Hai pattern n√†y t∆∞∆°ng ƒë∆∞∆°ng, n√≥ s·∫Ω match v·ªõi 1 ho·∫∑c nhi·ªÅu ch·ªØ s·ªë vi·∫øt li·ªÅn nhau.
D·∫•u `+` theo sau l√† bi·ªÉu di·ªÖn cho "1 ho·∫∑c nhi·ªÅu".
Ph·ªï bi·∫øn kh√¥ng k√©m d·∫•u `+`, l√† d·∫•u `*`. D·∫•u `*` c√≥ nghƒ©a l√† match 0 ho·∫∑c nhi·ªÅu:

- `\d*`
- `[0-9]*`

c≈©ng s·∫Ω match s·ªë ƒëi·ªán tho·∫°i di ƒë·ªông ·ªü Vi·ªát Nam.

D√πng `+` kh·∫≥ng ƒë·ªãnh ph·∫£i c√≥ √≠t nh·∫•t 1 s·ªë t·ª´ 0 ƒë·∫øn 9 (k√Ω hi·ªáu `[0-9]`),
th√¨ d√πng `*` d·ªÖ
d√£i h∆°n, kh√¥ng c√≥ s·ªë n√†o c≈©ng ƒë∆∞·ª£c. Pattern `.*` l√† pattern ph·ªï bi·∫øn nh·∫•t v·ªõi
ng∆∞·ªùi h·ªçc regex v·ªõi th·ªùi l∆∞·ª£ng d∆∞·ªõi 5 ng√†y.

`.` ƒë·∫°i di·ªán cho 1 k√Ω t·ª± n√†o ƒë√≥, n√†o c≈©ng ƒë∆∞·ª£c, a b c hay 0 1 2 hay % = # g√¨
c≈©ng ok. `.*` l√† pattern match ƒë∆∞·ª£c m·ªçi th·ª©.

Tr√°nh nh·∫ßm l·∫´n d·∫•u `*` hay th·∫•y khi g√µ c√¢u l·ªánh Linux, ki·ªÉu nh∆∞ `ls ~/*.py`,
`*` n√†y kh√¥ng ph·∫£i regex, ƒë√¢y l√† kh√°i ni·ªám `globbing`, m·∫∑c d√π t√°c d·ª•ng h∆°i gi·ªëng,
n√≥ s·∫Ω tr·∫£ v·ªÅ t·∫•t c·∫£ c√°c t√™n file c√≥ ƒëu√¥i `.py`

D·∫•u `?` match 0 ho·∫∑c 1 l·∫ßn, pattern `https?` s·∫Ω match c·∫£ `http` l·∫´n `https`

D√πng trang [regex101.com](https://regex101.com/r/2f1NKt/1) ƒë·ªÉ th·ª≠ c√°c pattern v√† xem k·∫øt qu·∫£ cho ti·ªán.

Hay b·∫≠t python3 l√™n r·ªìi g√µ

```sh
>>> import re
>>> re.findall('.*', '0987654321')
['0987654321', '']
```

C√≥ th·ªÉ ch·ªâ ƒë·ªãnh s·ªë l·∫ßn match v·ªõi c√∫ ph√°p `{√≠t nh·∫•t, nhi·ªÅu nh·∫•t}`, pattern 
`0[0-9]{9, 10}` match s·ªë ƒëi·ªán tho·∫°i di ƒë·ªông ·ªü Vi·ªát Nam.

ƒê∆°n gi·∫£n, ƒë√∫ng kh√¥ng? H√£y vi·∫øt 1 ƒëo·∫°n regex ƒë·ªÉ ki·ªÉm tra 1 email c√≥ h·ª£p l·ªá kh√¥ng.

M·ªçi ng∆∞·ªùi ƒë·ªÅu bi·∫øt "chung chung" l√† email c√≥ d·∫°ng `g√¨ƒë√≥@g√¨ƒë·∫•y.ƒëu√¥i`, v·∫≠y
regex c√≥ th·ªÉ l√† `.+@.+\..+`. Ch√∫ √Ω d·∫•u `.` trong t√™n mi·ªÅn ph·∫£i g√µ `\.`, v√¨
d·∫•u `.` l√† 1 k√Ω hi·ªáu regex ƒë·∫∑c bi·ªát ƒë√£ n√≥i ·ªü tr√™n.
ƒê√¢y l√† [regex ƒë·∫ßy ƒë·ªß ƒë·ªÉ ki·ªÉm tra 1 ƒë·ªãa ch·ªâ email](http://www.ex-parrot.com/~pdw/Mail-RFC822-Address.html).

ƒê·∫øn ƒë√¢y, ƒë√£ c√≥ 1 manh m·ªëi ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô r·ªìi...
N·∫øu ch∆∞a th·∫•y, h√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ g√µ ƒëo·∫°n code tr√™n. `re` l√† standard library
c·ªßa Python, c√≥ s·∫µn, kh√¥ng c√†i g√¨ c·∫£. Nh∆∞ng ƒëo·∫°n code
tr√™n l·∫°i import 1 th∆∞ vi·ªán t√™n [`regex`](https://pypi.org/project/regex/).
ƒê√¢y l√† th∆∞ vi·ªán ph·∫£i c√†i th√™m,

> This regex implementation is backwards-compatible with the standard ‚Äòre‚Äô
> module, but offers additional functionality.

Th·ª≠ thay `regex` b·∫±ng `re` gi√∫p c·∫Øt gi·∫£m 10s trong ƒëo·∫°n code ch·∫°y 60s tr√™n m√°y
t√°c gi·∫£.
C√≥ th·ªÉ "ƒëo√°n" r·∫±ng `re` c√≥ trong stdlib v√† ƒë∆∞·ª£c t·ªëi ∆∞u ƒë·ªß tr√≤ n√™n ch·∫°y nhanh h∆°n.
Nh·ªØng vi·ªác ƒëo√°n n√†y ph·∫£i d·ª±a tr√™n c∆° s·ªü ƒëo. ƒê·ªÉ ƒëo t·ªëc ƒë·ªô trong Python,
python c√≥ s√£n th∆∞ vi·ªán `cProfile`.

### Profiling Python v·ªõi cProfile

Thay regex b·∫±ng re,
ch·∫°y l·∫°i ƒëo·∫°n code v·ªõi c√¢u l·ªánh sau ƒë·ªÉ xem c√°c function n√†o d√πng nhi·ªÅu th·ªùi gian
nh·∫•t/g·ªçi nhi·ªÅu l·∫ßn nh·∫•t.

- `tottime` total time: t·ªïng th·ªùi gian function ch·∫°y sau N l·∫ßn,
kh√¥ng t√≠nh chuy·ªán g·ªçi function kh√°c.
- `cumtime` cummulative time: t·ªïng th·ªùi gian function ch·∫°y sau N l·∫ßn, bao 
g·ªìm c·∫£ vi·ªác g·ªçi c√°c function kh√°c.

```sh
$ /usr/bin/time -v python3 -m cProfile -s tottime albv1.py
Proceeded 50000 lines
         252074 function calls (251832 primitive calls) in 45.948 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    50000   45.834    0.001   45.834    0.001 {method 'match' of 're.Pattern' objects}
        1    0.033    0.033   45.948   45.948 albv1.py:1(<module>)
        1    0.016    0.016    0.061    0.061 {method 'readlines' of '_io._IOBase' objects}
     2277    0.014    0.000    0.014    0.000 {built-in method zlib.crc32}
    50000    0.012    0.000    0.012    0.000 {method 'group' of 're.Match' objects}
     2275    0.008    0.000    0.008    0.000 {method 'decompress' of 'zlib.Decompress' objects}
    50054    0.005    0.000    0.005    0.000 {method 'join' of 'str' objects}
    52282    0.004    0.000    0.004    0.000 gzip.py:314(closed)
     2276    0.004    0.000    0.034    0.000 _compression.py:66(readinto)

```

K·∫øt qu·∫£ cho th·∫•y h·∫ßu h·∫øt th·ªùi gian ƒë·ªÅu d√πng v√†o vi·ªác ch·∫°y regex method `match`.
[`re` vi·∫øt b·∫±ng C](https://github.com/python/cpython/blob/3.10/Modules/_sre.c),
l·∫Ω ra ph·∫£i ch·∫°y r·∫•t nhanh, th√¨ khi copy th·ª≠ pattern v√† 1
v√≠ d·ª• l√™n regex101, s·∫Ω th·∫•y l√Ω do v√¨ sao n√≥ ch·∫≠m. ƒê·ªÉ ki·ªÉm tra pattern c√≥ match
string v√≠ d·ª• sau kh√¥ng, [re ph·∫£i d√πng t·ªõi 112690 b∆∞·ªõc!!!](https://regex101.com/r/hmXaTV/1)

> http 2015-05-13T23:39:43.945958Z my-loadbalancer 192.168.131.39:2817 10.0.0.1:80 0.000073 0.001048 0.000057 200 200 0 29 "GET http://www.    example.com:80/index HTTP/1.1" "curl/7.38.0" - - arn:aws:elasticloadbalancing:us-west-2:123456789012:targetgroup/my-targets/73e2d6bc24d8a067 "    Root=1-58337262-36d228ad5d99923122bbe354"

con s·ªë n√†y qu√° l·ªõn, d√π c√≥ vi·∫øt ƒëo·∫°n code l·∫±ng nh·∫±ng v·ªõi 20 c√¢u if, c≈©ng
kh√¥ng th·ªÉ t·ªõi 112690 b∆∞·ªõc.
TƒÉng t·ªëc regex kh√¥ng ph·∫£i chuy·ªán d·ªÖ, nh∆∞ng c√≥ 1 tip r·∫•t ph·ªï bi·∫øn: ch·ªó n√†o
d√πng `.*` ch·ªó ƒë√≥ c√≥ v·∫ª ch·∫≠m/sai/c·∫ßn t·ªëi ∆∞u.

ƒêo·∫°n regex m·ªõi
```py
pattern = '(.*?) (.*?) (.*?) ([0-9.]+):([0-9]*) ([0-9.]+):([0-9]*) ([.0-9]*) ([.0-9]*) ([.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) "(.*?) https?://[^:]+:([0-9]+)([^? ]*)(\\x3f?.*?) (.*?)" "(.*?)" (.*?) (.*?) (.*?) "(.*?)" *$'
```
c√≥ 1 ƒëi·ªÉm kh√°c so v·ªõi ƒëo·∫°n c≈©
```py
pattern = '(.*?) (.*?) (.*?) ([0-9.]+):([0-9]*) ([0-9.]+):([0-9]*) ([.0-9]*) ([.0-9]*) ([.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) "(.*?) .*:([0-9]+)([^? ]*)(\\x3f?.*?) (.*?)" "(.*?)" (.*?) (.*?) (.*?) "(.*?)" *$'
```

ch·ªó `.*:([0-9]+)` d√πng ƒë·ªÉ match domain v√† port nh∆∞ https://pymi.vn:443, thay `.*` trong
ƒëo·∫°n n√†y v·ªõi `https?://[^:]+` cho t√°c d·ª•ng t∆∞∆°ng ƒë∆∞∆°ng. `https?://[^:]+` match
1 ƒëo·∫°n text b·∫Øt ƒë·∫ßu b·∫±ng http hay https, r·ªìi :// r·ªìi b·∫•t c·ª© th·ª© g√¨ cho t·ªõi khi
g·∫∑p d·∫•u : th√¨ d·ª´ng l·∫°i. ƒêo·∫°n n√†y [match sau 524 b∆∞·ªõc](https://regex101.com/r/1HqLtV/1)

Ch√∫ √Ω ƒëo·∫°n code m·ªõi cho r·∫±ng m·ªçi url ƒë·ªÅu b·∫Øt ƒë·∫ßu v·ªõi http hay https, ƒëi·ªÅu n√†y
c√≥ th·ªÉ sai (v√≠ d·ª• wss:// cho websocket), t√πy theo y√™u c·∫ßu b√†i to√°n.

M·ªôt c√°ch kh√°c, l√† d√πng pattern `[^:]+:[^:]+:` match m·ªçi th·ª© c√≥ d·∫°ng 
something:something d·ª´ng l·∫°i khi g·∫∑p d·∫•u : th·ª© 2.
VD patter s·∫Ω match `wss://abcde` trong string `wss://abcde:443`, 
pattern n√†y [match sau 518 b∆∞·ªõc](https://regex101.com/r/pjDFEk/1).

D·∫•u ƒë√≥ng m·ªü ngo·∫∑c `()` d√πng ƒë·ªÉ "capture", k·∫øt qu·∫£ match th√†nh c√¥ng s·∫Ω ƒë∆∞·ª£c l∆∞u
l·∫°i th√†nh 1 group, ƒë√°nh theo th·ª© t·ª± xu·∫•t hi·ªán. 
ƒêo·∫°n code trong b√†i l·∫•y ra group 17 v√† 11
t·ª´ k·∫øt qu·∫£ match.

```sh
$ /usr/bin/time -v python3 -m cProfile -s tottime albv1_regex.py

Proceeded 50000 lines
         252201 function calls (251956 primitive calls) in 0.310 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    50000    0.208    0.000    0.208    0.000 {method 'match' of 're.Pattern' objects}
        1    0.026    0.026    0.310    0.310 albv1_regex.py:1(<module>)
        1    0.016    0.016    0.061    0.061 {method 'readlines' of '_io._IOBase' objects}
     2277    0.014    0.000    0.014    0.000 {built-in method zlib.crc32}
    50000    0.008    0.000    0.008    0.000 {method 'group' of 're.Match' objects}
     2275    0.008    0.000    0.008    0.000 {method 'decompress' of 'zlib.Decompress' objects}
    52282    0.004    0.000    0.004    0.000 gzip.py:314(closed)
    50054    0.004    0.000    0.004    0.000 {method 'join' of 'str' objects}
     2276    0.004    0.000    0.030    0.000 gzip.py:454(read)
```

45 gi√¢y -> xu·ªëng c√≤n 0.3 gi√¢y cho ta c·∫£m gi√°c code m·ªõi ch·∫Øc l√† sai n√™n m·ªõi 150x nh∆∞ v·∫≠y.

#### S·ª≠a regex xong l√†m sao bi·∫øt ƒë√∫ng sai?
M·ªôt c√°ch ƒë∆°n gi·∫£n l√† th·ª≠, cho 2 pattern match v√† l·∫•y k·∫øt qu·∫£ ra r·ªìi so s√°nh l·∫ßn 
l∆∞·ª£t v·ªõi m·ªói d√≤ng log, qua c·∫£ file ƒë·ªÅu gi·ªëng nhau l√† c√≥ v·∫ª ·ªïn r·ªìi.

```py
p1 = re.compile(pattern1)
p2 = re.compile(pattern2)

for line in f:
    m1 = p1.match(line)
    m2 = p2.match(line)
    if m1: 
        assert m1.groups() == m2.group(), (m1, m2, line)
```


PS: khi t·ªëi ∆∞u ƒëo·∫°n code n√†y, v√¥ t√¨nh ph√°t hi·ªán ra ƒëo·∫°n code ban ƒë·∫ßu x·ª≠ l√Ω 
kh√¥ng ƒë√∫ng khi URL path c√≥ ch·ª©a d·∫•u `:`, 2 phi√™n b·∫£n m·ªõi kh√¥ng g·∫∑p ph·∫£i v·∫•n
ƒë·ªÅ n√†y.

K·∫øt lu·∫≠n 2: 150x l√† c√≥ th·∫≠t v√† kh√¥ng c·∫ßn ph·∫£i h·ªçc "regex" n√¢ng cao.

#### H·ªçc v√† d√πng regex

Python c√≥ vi·∫øt 1 t√†i li·ªáu c∆° b·∫£n v·ªÅ regex trong m·ª•c [howto](https://docs.python.org/3/howto/regex.html), 
n·∫øu m·ªôt ng√†y bu·ªìn ch√°n qu√° kh√¥ng c√≥ g√¨ l√†m, hay mu·ªën t√¨m hi·ªÉu v·ªÅ √Ω nghƒ©a c·ªßa cu·ªôc s·ªëng, b·∫°n c√≥ th·ªÉ ng·ªìi h·ªçc regex.

![xkcd](https://imgs.xkcd.com/comics/regular_expressions.png)

Ho·∫∑c ƒëi t√¨m m·ªôt "kh√≥a h·ªçc regex"? c√°i n√†y ch∆∞a c√≥, c∆° h·ªôi kh·ªüi nghi·ªáp l√†m gi√†u c√≤n r·∫•t r·ªông m·ªü
cho c√°c chuy√™n gia c√¥ng ngh·ªá b√°n "kho√° h·ªçc l√†m ch·ªß regex ƒë·ªÉ h·ªçc s√¢u v·ªõi tr√≠ tu·ªá nh√¢n t·∫°o 4.0".

Regex l√† m·ªôt c√¥ng c·ª• m·∫°nh, nh∆∞ng kh√≥ d√πng ƒë√∫ng, n√≥ gi·∫£i quy·∫øt ƒë∆∞·ª£c 1 s·ªë b√†i to√°n,
[1 s·ªë th√¨ kh√¥ng v√† n√™n d√πng c√°ch kh√°c ƒë∆°n gi·∫£n h∆°n nh∆∞ parse HTML](https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags?noredirect=1&lq=1).

regex [n·ªïi ti·∫øng ph·ª©c t·∫°p](https://blog.codinghorror.com/regular-expressions-now-you-have-two-problems/), v√† t·ª´ng t·∫°o ra kh√¥ng √≠t [s·ª± c·ªë trong c√°c h·ªá th·ªëng l·ªõn to√†n c·∫ßu](https://stackstatus.net/post/147710624694/outage-postmortem-july-20-2016).

> Some people, when confronted with a problem, think "I know, I'll use regular expressions." Now they have two problems.

Khi m·ªôt b√†i to√°n c√≥ th·ªÉ gi·∫£i quy·∫øt theo 1 c√°ch kh√°c ƒë∆°n gi·∫£n h∆°n, th√¨ n√™n tr√°nh
d√πng regex.

Ch√∫ √Ω trong ph·∫ßn t·ªëi ∆∞u n√†y, nh·∫±m m·ª•c ti√™u gi·ªØ l·∫°i code g·∫ßn gi·ªëng v·ªõi code
ban ƒë·∫ßu nh·∫•t, kh√¥ng thay ƒë·ªïi g√¨ qu√° nhi·ªÅu, t√°c gi·∫£ ƒë√£ kh√¥ng vi·∫øt l·∫°i ƒëo·∫°n code 
l·ªçc ra urlpath v√† statuscode m√† v·∫´n gi·ªØ nguy√™n regex nh∆∞ code ban ƒë·∫ßu.

## TƒÉng t·ªëc kafka
ƒê√¢y l√† phi√™n b·∫£n ƒë·∫ßy ƒë·ªß c·ªßa ch∆∞∆°ng tr√¨nh tr∆∞·ªõc khi mang ƒëi t·ªëi ∆∞u: n√≥
ƒë·ªçc file log [AWS ALB](https://aws.amazon.com/premiumsupport/knowledge-center/athena-analyze-access-logs/)
ƒë√£ n√©n `.gz`, l·∫•y ra urlpath v√† status code b·∫±ng regex, r·ªìi g·ª≠i
k·∫øt qu·∫£ ƒë·∫øn kafka.

### Kafka l√† g√¨
> Apache Kafka is an open-source distributed event streaming platform used by thousands of companies for high-performance data pipelines, streaming analytics, data integration, and mission-critical applications. 

[https://kafka.apache.org/](https://kafka.apache.org/)

N√≥i ƒë∆°n gi·∫£n, Kafka nh∆∞ h·ªá th·ªëng ·ªëng n∆∞·ªõc, m·∫°ng l∆∞·ªõi ƒëi·ªán, m·∫°ng l∆∞·ªõi vi·ªÖn th√¥ng,
n√≥ ƒë·ªß ph·ª©c t·∫°p ƒë·ªÉ ƒë√°p ·ª©ng m·ªçi nhu c·∫ßu truy·ªÅn t·∫£i d·ªØ li·ªáu t·ª´ nhi·ªÅu ngu·ªìn ƒë·∫øn 
nhi·ªÅu ƒë√≠ch. Kafka ƒë∆∞·ª£c d√πng ph·ªï bi·∫øn trong c√°c doanh nghi·ªáp, c√°c h·ªá th·ªëng x·ª≠
l√Ω data, logging...

Kafka c√≥ nhi·ªÅu t√≠nh nƒÉng, b√†i n√†y s·ª≠ d·ª•ng n√≥ nh∆∞ 1 h·ªá th·ªëng pub-sub, t·ª©c c√≥ 1
b√™n g·ª≠i message ƒëi, v√† 1/nhi·ªÅu b√™n nh·∫≠n message.

C√†i Java

```sh
sudo apt-get update && sudo apt-get install -y openjdk-11-jre-headless
```

C√†i ƒë·∫∑t kafka ƒë∆°n gi·∫£n v·ªõi [5 b∆∞·ªõc kh√¥ng c·∫ßn sudo](https://kafka.apache.org/quickstart)

```sh
curl -LO https://mirror.downloadvn.com/apache/kafka/2.8.0/kafka_2.13-2.8.0.tgz
tar xvf kafka_2.13-2.8.0.tgz
cd kafka_2.13-2.8.0
bin/zookeeper-server-start.sh config/zookeeper.properties
## m·ªü 1 terminal kh√°c
cd kafka_2.13-2.8.0
bin/kafka-server-start.sh config/server.properties
```

#### Kafka producer
```py
import gzip                                                                     
import re                                                                       
from kafka import KafkaProducer                                                 
                                                                                
producer = KafkaProducer(linger_ms=5, batch_size=65536, acks=0, compression_type="lz4")
                                                                                
pattern = '(.*?) (.*?) (.*?) ([0-9.]+):([0-9]*) ([0-9.]+):([0-9]*) ([.0-9]*) ([.0-9]*) ([.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) "(.*?) [^:]+:[^:]+:([0-9]+)([^? ]*)(\\x3f?.*?) (.*?)" "(.*?)" (.*?) (.*?) (.*?) "(.*?)" *$'                                                                                                                                              
p = re.compile(pattern)                                                         
                                                                                
i = 0                                                                           
with gzip.open("bigfile.log.gz", "rt") as f:                                    
    for line in f:                                                              
        i = i + 1                                                               
        if i % 10000 == 0:                                                      
            print(i)                                                            
        m = p.match(line)                                                       
        if m:                                                                   
            result = " ".join(m.group(17, 11))                                  
            producer.send("alblog", result.encode("utf-8"))                     
                                                                                
print("Processed {} lines".format(i)) 
```
Khi ch∆∞a g·ª≠i message t·ªõi kafka, code ch·∫°y m·∫•t 8s, khi g·ª≠i ƒë·∫øn kafka tr√™n c√πng
m√°y, code ch·∫°y m·∫•t 60s (khi profile ch·∫≠m h∆°n n·ªØa do qu√° tr√¨nh profile can thi·ªáp ·∫£nh h∆∞·ªüng t·ªõi t·ªëc ƒë·ªô):

```
Processed 1500000 lines
         133875187 function calls (133873425 primitive calls) in 91.895 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
  1500001    8.978    0.000    8.978    0.000 {method 'match' of 're.Pattern' objects}
  1500000    8.602    0.000   73.735    0.000 kafka.py:538(send)
  1500282    7.845    0.000   14.095    0.000 default_records.py:406(append)
  1500000    6.948    0.000   39.138    0.000 record_accumulator.py:200(append)
  1500282    4.675    0.000   28.579    0.000 record_accumulator.py:57(try_append)
        1    4.299    4.299   92.439   92.439 albv1_regex2.py:1(<module>)
  1500000    4.147    0.000    6.439    0.000 future.py:32(__init__)
  7501128    3.138    0.000    4.001    0.000 util.py:10(encode_varint)
  1500000    2.754    0.000   12.242    0.000 kafka.py:716(_partition)
  3000001    2.270    0.000    2.688    0.000 cluster.py:106(partitions_for_topic)
  1500000    1.946    0.000    4.090    0.000 cluster.py:119(available_partitions_for_topic)
  1500000    1.840    0.000    4.318    0.000 kafka.py:664(_wait_on_metadata)
    65554    1.721    0.000    1.721    0.000 {built-in method zlib.crc32}
  1500000    1.682    0.000    2.811    0.000 default_records.py:563(size_of)
15397286/15397055    1.615    0.000    1.615    0.000 {built-in method builtins.len}
...
```

Vi·ªác g·ª≠i 1.5 tri·ªáu message t·ªõi kafka ch·∫°y c√πng m√°y m·∫•t t·ªõi 73s (cumtime)
trong output profiling. Trong ƒë√≥ c√≥ d√≤ng th·ª© 3, 4 v√† 5 ƒë·ªÅu l√† "append".
M·ªü code c·ªßa th∆∞ vi·ªán [kafka-python](https://github.com/dpkp/kafka-python/) 
ra xem, ph·∫ßn [n√†y](https://github.com/dpkp/kafka-python/blob/2.0.2/kafka/producer/record_accumulator.py#L200)
append c√°c message v√†o
1 list "accumulator", ƒë·ªÉ bao gi·ªù ƒë·ªß 65536 ph·∫ßn t·ª≠ m·ªõi g·ª≠i ƒëi 
(batch_size=65536 l√∫c t·∫°o producer). Batching l√† t√≠nh nƒÉng ph·ªï bi·∫øn trong c√°c 
th∆∞ vi·ªán li√™n quan t·ªõi network, do vi·ªác g·ª≠i nh·∫≠n qua network th∆∞·ªùng ch·∫≠m, n√™n
gom l·∫°i m·ªôt ƒë·ªëng r·ªìi g·ª≠i ƒëi ƒë·ªÉ gi·∫£m s·ªë l·∫ßn g·ª≠i/nh·∫≠n. Nh∆∞ng trong v√≠ d·ª• n√†y,
vi·ªác batching t·ªën t·ªõi 20s th√¨ c√≥ v·∫ª kh√¥ng ·ªïn.
Sau m·ªôt h·ªìi ch·ªânh s·ª≠a c√°c tham s·ªë (batch_size, linger_ms ...), gi·∫£i ph√°p l·∫°i l√†
"think outside of the box", t√¨m xem Python c√≤n c√≥ th∆∞ vi·ªán kafka n√†o kh√°c kh√¥ng.

Th∆∞ vi·ªán [confluent-kafka-python](https://github.com/confluentinc/confluent-kafka-python) s·ª≠ d·ª•ng 
[librdkafka](https://github.com/edenhill/librdkafka) vi·∫øt b·∫±ng C h·ª©a h·∫πn cho m·ªôt performance
t·ªët h∆°n nhi·ªÅu

```py
import gzip
import re
from confluent_kafka import Producer


producer = Producer(
    {'bootstrap.servers': "localhost:9092",
    'queue.buffering.max.messages': 65536,
    'acks': 0,
     'compression.type': 'lz4'}
)


pattern = '(.*?) (.*?) (.*?) ([0-9.]+):([0-9]*) ([0-9.]+):([0-9]*) ([.0-9]*) ([.0-9]*) ([.0-9]*) (-|[0-9]*) (-|[0-9]*) ([-0-9]*) ([-0-9]*) "(.*?) [^:]+:[^:]+:([0-9]+)([^? ]*)(\\x3f?.*?) (.*?)" "(.*?)" (.*?) (.*?) (.*?) "(.*?)" *$'

p = re.compile(pattern)

i = 0
with gzip.open("bigfile.log.gz", "rt") as f:
    for line in f:
        i = i + 1
        if i % 10000 == 0:
            print(i)
        m = p.match(line)
        if m:
            result = " ".join(m.group(17, 11))
            try:
                producer.produce("alblog", result.encode("utf-8"))
                producer.poll(0)
            except BufferError:
                print("Buffer full, waiting for free space on the queue")
                producer.poll(1)
    producer.flush()

print("Processed {} lines".format(i))
```
v√† th·ª±c nghi·ªám th·∫•y ƒë√∫ng l√† nh∆∞ th·∫ø:

```py
Processed 1500000 lines
         11882360 function calls (11882085 primitive calls) in 21.700 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
  1500000    9.328    0.000    9.328    0.000 {method 'match' of 're.Pattern' objects}
  1500000    4.197    0.000    4.197    0.000 {method 'produce' of 'cimpl.Producer' objects}
        1    3.457    3.457   21.700   21.700 albv1_regex2.py:1(<module>)
  1500000    1.511    0.000    1.511    0.000 {method 'poll' of 'cimpl.Producer' objects}
    65554    0.519    0.000    0.519    0.000 {built-in method zlib.crc32}
  1500000    0.410    0.000    0.410    0.000 {method 'group' of 're.Match' objects}
    65552    0.386    0.000    0.386    0.000 {method 'decompress' of 'zlib.Decompress' objects}
  1565559    0.255    0.000    0.255    0.000 gzip.py:314(closed)
  1500117    0.232    0.000    0.232    0.000 {method 'join' of 'str' objects}
    65553    0.218    0.000    1.687    0.000 _compression.py:66(readinto)
    65553    0.207    0.000    1.417    0.000 gzip.py:454(read)
```

T·ª´ 91s -> 21.7s, ta r√∫t g·ªçn th√™m ƒë∆∞·ª£c 4x.

K·∫øt lu·∫≠n 3: th∆∞ vi·ªán c√≥ this c√≥ that, h√£y t·ª± ƒëo v√† ki·ªÉm tra c√°c options.

## K·∫øt qu·∫£
Sau 3 l·∫ßn t·ªëi ∆∞u, code m·ªõi d√πng 100x √≠t RAM h∆°n, nhanh g·∫•p 150 * 4 == 600 l·∫ßn
code ban ƒë·∫ßu, chi ph√≠ gi·∫£m: 600 l·∫ßn so v·ªõi ban ƒë·∫ßu. Gi·∫£ s·ª≠ ƒëo·∫°n code n√†y hi·ªán
ƒëang t·ªën $6000/th√°ng (6 * 12 = $72k/nƒÉm), th√¨ sau khi t·ªëi ∆∞u c√≤n $10/th√°ng -> $120/nƒÉm.

$70.000 m·ªói nƒÉm ƒë∆∞·ª£c ti·∫øt ki·ªám n√†y n√™n d√πng ƒë·ªÉ th∆∞·ªüng n√≥ng cho 10x dev hay 
ch·ªâ th∆∞·ªüng $7k? 

Th·ª±c t·∫ø (kinh t·∫ø) th√¨ kh√¥ng ph·∫£i th·∫ø, th∆∞·ªüng n√≥ng $1-2-3k ƒë√£ l√† nhi·ªÅu l·∫Øm r·ªìi.
Kh√¥ng b√†n t·ªõi chuy·ªán qu·∫£n l√Ω doanh nghi·ªáp/nh√¢n s·ª±/kinh t·∫ø ·ªü ƒë√¢y, nh∆∞ng c√≥ th·ªÉ
th·∫•y 1 ƒëi·ªÅu, 1 l·∫≠p tr√¨nh vi√™n c√≥ m·ª©c l∆∞∆°ng cao ng·∫•t ng∆∞·ªüng kh√¥ng ph·∫£i l√†
chuy·ªán v√¥ l√Ω, khi h·ªç c√≥ th·ªÉ t·ª± tr·∫£ l∆∞∆°ng cho m√¨nh 1 v√†i nƒÉm trong v√≤ng 1 2 ng√†y
t·ªëi ∆∞u code.

## K·∫øt lu·∫≠n
10x engineering kh√¥ng ph·∫£i chuy·ªán h∆∞ c·∫•u, l√† c√≥ th·∫≠t. 10x ph·ª• thu·ªôc v√†o
ho√†n c·∫£nh, ti√™u ch√≠ ƒë√°nh gi√°, nh∆∞ng h·ªçc Python t·∫°i PyMi.vn r√µ r√†ng l√† kho·∫£n ƒë·∫ßu t∆∞ 10x.
Vi·ªác t·ªëi ∆∞u code, s·ª≠ d·ª•ng cProfile c·ªßa Python l√† m·ªôt c√¥ng vi·ªác th√∫ v·ªã, nh∆∞ng 
c·∫ßn ƒë·∫∑t v√†o ƒë√∫ng ch·ªó. T·ªëi ∆∞u ƒëo·∫°n code ti√™u t·ªën $72k/nƒÉm ƒë·ªÉ c√≤n $120/nƒÉm 
mang l·∫°i l·ª£i √≠ch kinh t·∫ø kh√°c bi·ªát so v·ªõi t·ªëi ∆∞u ƒëo·∫°n code $72/nƒÉm c√≤n $0.12/nƒÉm. 

B·∫°n ƒë·ªçc ƒëam m√™ c√≥ th·ªÉ ti·∫øp t·ª•c t·ªëi ∆∞u v√† g·ª≠i k·∫øt qu·∫£ t·ªõi t√°c gi·∫£ b·∫±ng c√°ch 
t·∫°o [1 pull request tr√™n GitHub](https://github.com/pymivn/people/pulls).
Ngo√†i ra, c√≥ th·ªÉ vi·∫øt h·∫≥n 1 ch∆∞∆°ng tr√¨nh h·∫≥n hoi gi√∫p l·∫•y log AWS load balancer
v·ªÅ r·ªìi g·ª≠i t·ªõi 1 ƒë√≠ch ƒë·∫øn t√πy √Ω. ƒê√¢y l√† [m·ªôt v·∫•n ƒë·ªÅ ph·ªï bi·∫øn khi d√πng AWS Load Balancer
m√† ch∆∞a c√≥ gi·∫£i ph√°p tri·ªát ƒë·ªÉ.](https://www.google.com/search?q=parse+aws+application+load+balancer+logs&hl=en)

## References
- [serverless](https://www.familug.org/2017/08/serverless.html)
- [globbing vs regex](https://www.familug.org/2014/09/shell-globbing-not-regex.html)
- [grep & 3 modes of regex](https://www.familug.org/2020/10/grep-khong-ho-tro-d-va-3-mode-regex.html)

## H·∫øt
B√†i vi·∫øt th·ª±c hi·ªán tr√™n
```sh
$ grep VERSION= /etc/os-release; python3 --version
VERSION="20.04.2 LTS (Focal Fossa)"
Python 3.8.5
```
HVN at [http://pymi.vn](http://pymi.vn) and [https://www.familug.org](https://www.familug.org).

- [·ª¶ng h·ªô t√°c gi·∫£ üç∫](https://www.familug.org/p/ung-ho.html)
