<!DOCTYPE html>
<html lang="vi">

<head>
   <title> CÃ³ Salt khÃ´ng lo cháº¿t Ä‘Ã³i  - The PyMiers</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="robots" content="" />
  <link rel="stylesheet" type="text/css" href="/theme/css/app.css">
<link rel="stylesheet" type="text/css" href="http://pp.pymi.vn/theme/css/pygment.css">
  <!--
  <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
  -->

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">    <meta name="author" content="Pymiers" />
  <meta name="description" content="" />    <link href="http://pp.pymi.vn/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The PyMiers Full Atom Feed" />         
  <meta name="tags" content="saltstack" />
  <meta name="tags" content="salt" />
  <meta name="tags" content="deploy" />
  <meta name="tags" content="devops" />
  <meta name="tags" content="ansible" />
  <meta name="tags" content="sysadmin" />
</head>

<body>
  <main class="wrapper">
    <section class="container">
      <header class='column'>
        <h1 class='title'><a href="http://pp.pymi.vn/">The PyMiers</a></h1>
      </header>

      <div class="section">
        <div class="row navbar">
          <div class="column nav-item is-active"><a href="http://pp.pymi.vn/category/trang-chu/">Trang chá»§</a></div>
           <div class="column nav-item "><a href="http://pp.pymi.vn/pages/about/">About</a></div>
          <div class="column nav-item "><a href="http://pp.pymi.vn/pages/add/">Táº¡o bÃ i viáº¿t</a></div>
          <div class="column nav-item "><a href="http://pp.pymi.vn/pages/rss/">RSS</a></div>
          <div class="column nav-item"><a href="/archives">Archives</a></div>
        </div>
      </div>
    </section>

<section class="container">
  <header>
    <h2 class="entry-title">
      <a href="http://pp.pymi.vn/article/salt/" rel="bookmark"
         title="Permalink to CÃ³ Salt khÃ´ng lo cháº¿t Ä‘Ã³i">CÃ³ Salt khÃ´ng lo cháº¿t Ä‘Ã³i</a></h2>  
  </header>
  <footer class='center'>
    <time class="published" datetime="2021-06-19T00:00:00+07:00"> 19/06/2021 </time>
    <address class="vcard author">By
                    <a class="url fn" href="http://pp.pymi.vn/author/hvnsweeting/">hvnsweeting</a>
 in <a href="http://pp.pymi.vn/category/trang-chu/">Trang chá»§</a>
                </address>     <em>Tags</em>:     <a href="http://pp.pymi.vn/tag/saltstack/"><em>saltstack</em></a>,     <a href="http://pp.pymi.vn/tag/salt/"><em>salt</em></a>,     <a href="http://pp.pymi.vn/tag/deploy/"><em>deploy</em></a>,     <a href="http://pp.pymi.vn/tag/devops/"><em>devops</em></a>,     <a href="http://pp.pymi.vn/tag/ansible/"><em>ansible</em></a>,     <a href="http://pp.pymi.vn/tag/sysadmin/"><em>sysadmin</em></a>    </footer>
  <br>
  <div class="entry-content">
    <p><img alt="salt" src="https://gitlab.com/saltstack/open/salt-branding-guide/-/raw/master/logos/SaltProject_altlogo_teal.png?inline=true"></p>
<h2>Salt lÃ  gÃ¬</h2>
<p>Salt (/sÉ”Ëlt/ /sÉ’lt/) lÃ  má»™t pháº§n má»m mÃ£ nguá»“n má»Ÿ, má»™t há»‡ thá»‘ng
thuá»™c nhÃ³m Configuration Management (CM), viáº¿t báº±ng Python, sá»­ dá»¥ng YAML lÃ m ngÃ´n
ngá»¯ giao tiáº¿p vá»›i ngÆ°á»i dÃ¹ng.</p>
<h2>Salt lÃ m gÃ¬?</h2>
<p>TÃ­nh nÄƒng cá»§a Salt chia lÃ m 2 pháº§n chÃ­nh: remote execution vÃ  configuration
management dá»±a trÃªn ná»n táº£ng remote execution.</p>
<h3>Remote execution</h3>
<p>cháº¡y lá»‡nh tá»« xa. Sau khi cÃ i Ä‘áº·t xong salt-master vÃ  cÃ¡c salt-minion, tá»«
salt-master cÃ³ thá»ƒ cháº¡y báº¥t kÃ¬ cÃ¢u lá»‡nh nÃ o trÃªn mÃ¡y cÃ i salt-minion.</p>
<p>TÆ°á»Ÿng tÆ°á»£ng báº¡n cáº§n xoÃ¡ 1 file trÃªn 10 hay 100 mÃ¡y, chá»‰ cáº§n gÃµ 1 cÃ¢u lá»‡nh vÃ 
táº¥t cáº£ cÃ¡c minion sáº½ cháº¡y cÃ¢u lá»‡nh áº¥y. Sá»©c máº¡nh lÃ  vÃ´ cÃ¹ng khá»§ng khiáº¿p, giá»‘ng
nhÆ° náº¯m má»™t máº¡ng botnet trong tay váº­y. Muá»‘n ping 1 server tá»« 100 mÃ¡y? gÃµ lá»‡nh
<code>ping -c N victim</code>, vÃ  100 mÃ¡y sáº½ cÃ¹ng lÃºc ping Ä‘áº¿n mÃ¡y Ä‘Ã­ch.</p>
<h3>Configuration management</h3>
<p>Ä‘áº£m báº£o tráº¡ng thÃ¡i cÃ¡c thÃ nh pháº§n cá»§a há»‡ thá»‘ng. Cáº§n Ä‘áº£m báº£o 1 service NGINX
cháº¡y vá»›i file cáº¥u hÃ¬nh nháº¥t Ä‘á»‹nh, forward request Ä‘áº¿n gunicorn app
server trÃªn mÃ¡y áº¥y, Ä‘Ã£ cáº¥u hÃ¬nh Ä‘á»ƒ cháº¡y má»™t web application viáº¿t báº±ng Python
vá»›i phiÃªn báº£n má»›i nháº¥t láº¥y tá»« 1 git repository? Salt lÃ m Ä‘Æ°á»£c táº¥t cáº£ Ä‘iá»u Ä‘Ã³,
vÃ  nÃ³ cÃ³ thá»ƒ Ä‘áº£m báº£o ráº±ng má»i thay Ä‘á»•i báº±ng tay thá»±c hiá»‡n trÃªn nhá»¯ng thÃ nh
pháº§n nÃ³i trÃªn sáº½ bá»‹ thay tháº¿ báº±ng nhá»¯ng gÃ¬ Ä‘Ã£ Ä‘á»‹nh trÆ°á»›c.</p>
<p>Theo <a href="https://www.familug.org/2015/06/saltstack-chao-muoi-em-la-ai.html">ChÃ o Muá»‘i, em lÃ  ai? </a></p>
<h2>Má»¥c tiÃªu</h2>
<p>BÃ i nÃ y cÃ i Ä‘áº·t salt qua <code>pip</code>, vÃ  dÃ¹ng <code>salt-ssh</code> Ä‘á»ƒ Ä‘iá»u khiá»ƒn mÃ¡y khÃ¡c.
Má»¥c tiÃªu Ä‘Æ°a ra má»™t bÃ i hÆ°á»›ng dáº«n thá»±c hÃ nh Ä‘Æ¡n giáº£n hÆ¡n bÃ i hÆ°á»›ng dáº«n trÃªn
trang chá»§ <a href="https://docs.saltproject.io/en/master/topics/tutorials/walkthrough.html#salt-in-10-minutes/">Salt in 10 minutes</a>
vÃ  mang láº¡i cáº£m giÃ¡c giá»‘ng Ä‘ang dÃ¹ng <a href="https://www.familug.org/2016/12/ansible-command.html">Ansible</a>.</p>
<p>Káº¿t quáº£: deploy uds bot - 1 chÆ°Æ¡ng trÃ¬nh Python lÃªn mÃ¡y Ubuntu 18.04, cáº¥u hÃ¬nh
systemd cháº¡y vÃ¹ vÃ¹.</p>
<h2>3 phÃºt dÃ nh cho lÃ½ thuyáº¿t</h2>
<ul>
<li>MÃ¡y ra lá»‡nh gá»i lÃ  salt master</li>
<li>MÃ¡y bá»‹ Ä‘iá»u khiá»ƒn, cháº¡y cÃ¡c cÃ¢u lá»‡nh gá»i lÃ  salt minion, trong bÃ i nÃ y cÃ³ IP <code>192.168.0.110</code></li>
<li>Trong bÃ i nÃ y, master sáº½ truy cáº­p vÃ o minion qua ssh.</li>
<li>MÃ¡y master khÃ´ng cáº§n quyá»n gÃ¬ Ä‘áº·c biá»‡t vÃ  Ä‘Ã£ cÃ i Ä‘áº·t salt trÃªn Python3.6+</li>
<li>MÃ¡y minion cháº¡y <code>*NIX</code> OS (Ubuntu, Debian, Fedora, .. MacOS),
  pháº£i cÃ³ quyá»n sudo khÃ´ng password hoáº·c root Ä‘á»ƒ toÃ n quyá»n Ä‘iá»u khiá»ƒn mÃ¡y (nhÆ° cÃ i package qua
apt). <a href="https://docs.saltproject.io/en/latest/topics/installation/windows.html">Salt cÃ³ há»— trá»£ Windows</a> nhÆ°ng náº±m ngoÃ i pháº¡m vi bÃ i viáº¿t nÃ y.</li>
</ul>
<h2>TrÃªn mÃ¡y minion</h2>
<ul>
<li>Táº¡o 1 user má»›i: <code>sudo adduser saltuser</code>, tráº£ lá»i cÃ¡c cÃ¢u há»i vÃ  gÃµ password</li>
<li>sudo khÃ´ng password: thÃªm <code>saltuser ALL=(ALL) NOPASSWD: ALL</code> vÃ o cuá»‘i file /etc/sudoers</li>
<li>CÃ³ chÆ°Æ¡ng trÃ¬nh sshd listen trÃªn port 22, cÃ i báº±ng lá»‡nh <code>sudo apt install openssh-server</code>, gÃµ <code>ss -nlt | grep 22</code> tháº¥y cÃ³ káº¿t quáº£ lÃ  ok.</li>
</ul>
<h2>TrÃªn mÃ¡y master</h2>
<p>Táº¡o SSH key náº¿u chÆ°a cÃ³:</p>
<div class="highlight"><pre><span></span><code>ls ~/.ssh/id_rsa <span class="o">||</span> ssh-keygen
</code></pre></div>

<p>Copy ssh public key vÃ o minion:</p>
<div class="highlight"><pre><span></span><code>ssh-copy-id saltuser@192.168.0.110
<span class="c1"># rá»“i gÃµ password saltuser vá»«a táº¡o</span>
</code></pre></div>

<h3>CÃ i Ä‘áº·t</h3>
<p>Táº¡o 1 virtualenv:</p>
<div class="highlight"><pre><span></span><code>python3 -m venv saltenv
. saltenv/bin/activate
pip install <span class="nv">salt</span><span class="o">==</span><span class="m">3002</span>  <span class="c1"># do báº£n 3003 má»›i nháº¥t Ä‘ang cÃ³ bug</span>
</code></pre></div>

<p>CÃ i xong kiá»ƒm tra</p>
<div class="highlight"><pre><span></span><code>$ salt-ssh --version
salt-ssh <span class="m">3002</span>
</code></pre></div>

<h3>Cáº¥u hÃ¬nh master</h3>
<p>CÃ³ 2 file cáº§n táº¡o: <code>master</code> vÃ  <code>roster</code></p>
<p>Táº¡o 1 thÆ° má»¥c tÃªn saltlab:</p>
<div class="highlight"><pre><span></span><code>mkdir -p ~/saltlab/states
<span class="nb">cd</span> ~/saltlab
<span class="nb">pwd</span>
</code></pre></div>

<p>File <code>master</code> chá»©a 2 dÃ²ng, <code>root_dir</code> giÃ¡ trá»‹ lÃ  Ä‘Æ°á»ng dáº«n Ä‘áº§y Ä‘á»§ tá»›i
thÆ° muc saltlab, <code>file_roots</code> cÃ³ <code>states</code> vá»›i giÃ¡ trá»‹ lÃ  Ä‘Æ°á»ng dáº«n Ä‘áº§y Ä‘á»§
tá»›i thÆ° má»¥c <code>states</code>, thÆ° má»¥c states sáº½ chá»©a cÃ¡c file "saltstate"</p>
<div class="highlight"><pre><span></span><code><span class="nt">root_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/home/hvn/saltlab</span>
<span class="nt">file_roots</span><span class="p">:</span>
  <span class="nt">base</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/home/hvn/saltlab/states</span>
<span class="nt">pillar_roots</span><span class="p">:</span>
  <span class="nt">base</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/home/hvn/saltlab/pillars</span>
</code></pre></div>

<p>File <code>roster</code> chá»©a thÃ´ng tin vá» cÃ¡c mÃ¡y minion:</p>
<div class="highlight"><pre><span></span><code><span class="nt">tv</span><span class="p">:</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.0.110</span>
  <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">saltuser</span>
  <span class="nt">sudo</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="nt">trau</span><span class="p">:</span>
  <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">103.x.y.z</span>
  <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">22022</span>
</code></pre></div>

<p>á»Ÿ Ä‘Ã¢y Ä‘á»‹nh nghÄ©a 2 minion, 1 tÃªn <code>tv</code> vÃ  1 tÃªn <code>trau</code>, minion <code>tv</code> sáº½ lÃ  Ä‘á»‘i
tÆ°á»£ng cá»§a bÃ i nÃ y.</p>
<p>File nÃ y tÆ°Æ¡ng tá»± file inventory (hay cÃ³ tÃªn lÃ  <code>hosts</code>) cá»§a Ansible.</p>
<p>Cáº¥u trÃºc thÆ° má»¥c trÃ´ng nhÆ° sau</p>
<div class="highlight"><pre><span></span><code>saltlab/
â”œâ”€â”€ master
â”œâ”€â”€ roster
â”œâ”€â”€ pillars
â”‚Â Â  â”œâ”€â”€ common.sls
â”‚Â Â  â”œâ”€â”€ top.sls
â”‚Â Â  â””â”€â”€ uds.sls
â””â”€â”€ states
    â”œâ”€â”€ example.sls
    â”œâ”€â”€ htop.sls
    â”œâ”€â”€ template.j2
    â”œâ”€â”€ uds.sls
    â””â”€â”€ uds.systemd
</code></pre></div>

<h2>Cháº¡y cÃ¢u lá»‡nh Salt</h2>
<p>Tá»« master, trong venv saltenv, gÃµ lá»‡nh <code>salt-ssh</code> vá»›i Ä‘á»‘i tÆ°á»£ng <code>tv</code>, cÃ¢u lá»‡nh
salt <code>cmd.run</code>, cÃ¢u lá»‡nh cháº¡y trÃªn <code>tv</code> lÃ  <code>uname -a</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>saltenv<span class="o">)</span> $ salt-ssh --config ~/saltlab tv cmd.run <span class="s1">&#39;uname -a&#39;</span>
tv:
    Linux MINIPC-PN50 <span class="m">5</span>.8.0-55-generic <span class="c1">#62~20.04.1-Ubuntu SMP Wed Jun 2 08:55:04 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div>

<h2>Apply Salt state</h2>
<p>Saltstate file lÃ  <a href="https://docs.saltproject.io/en/latest/topics/yaml/index.html">file YAML</a> cÃ³ Ä‘uÃ´i <code>.sls</code>, khai bÃ¡o (declare)
tráº¡ng thÃ¡i cá»§a há»‡ thá»‘ng mong muá»‘n Ä‘áº¡t Ä‘Æ°á»£c. File <code>htop.sls</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">install htop</span><span class="p">:</span>   <span class="c1">#  ID cá»§a &quot;state&quot;</span>
  <span class="nt">pkg.installed</span><span class="p">:</span>  <span class="c1"># loáº¡i state - tÆ°Æ¡ng á»©ng vá»›i 1 python function</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">htop</span>   <span class="c1"># cÃ¡c tham sá»‘ - function argument</span>
</code></pre></div>

<p>CÃº phÃ¡p YAML trÃªn tÆ°Æ¡ng á»©ng vá»›i Python dict sau:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="s1">&#39;install htop&#39;</span><span class="p">:</span>
  <span class="p">{</span><span class="s1">&#39;pkg.installed&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;htop&#39;</span><span class="p">}]}}</span>
</code></pre></div>

<p>Sau khi Ä‘Æ°á»£c <code>apply</code>, state trÃªn sáº½ cÃ i package <code>htop</code> lÃªn mÃ¡y, sá»­ dá»¥ng package
manager cá»§a mÃ¡y minion, dÃ¹ lÃ  apt trÃªn Ubuntu hay yum/dnf trÃªn Fedora.</p>
<p>ÄÃ¢y lÃ  má»™t Æ°u Ä‘iá»ƒm lá»›n cá»§a Salt, ngÆ°á»i dÃ¹ng tháº­m chÃ­ khÃ´ng biáº¿t chÃ­nh xÃ¡c
cÃ¢u lá»‡nh Ä‘á»ƒ cÃ i tháº¿ nÃ o, chá»‰ cáº§n liá»‡t kÃª ra nhá»¯ng gÃ¬ mÃ¬nh cáº§n, Salt sáº½ lo táº¥t.
Pháº§n nÃ y nghe ráº¥t "magic", thá»±c cháº¥t thÃ¬ bÃªn dÆ°á»›i pkg lÃ  1 <a href="https://github.com/saltstack/salt/blob/master/salt/states/pkg.py">Python module</a>
cÃ²n <a href="https://github.com/saltstack/salt/blob/v3003/salt/states/pkg.py#L1007"><code>installed</code> lÃ  1 function</a>
cháº¡y Ä‘á»§ loáº¡i if/else kiá»ƒm tra há»‡ thá»‘ng vÃ  chá»n <code>apt</code> hay <code>yum</code> cho phÃ¹ há»£p.
Salt gá»i Ä‘Ã¢y lÃ  <a href="https://docs.saltproject.io/en/latest/ref/states/all/index.html"><code>state module pkg</code></a>.</p>
<p>GÃµ trÃªn master:</p>
<div class="highlight"><pre><span></span><code>$ salt-ssh --config ~/saltlab tv state.apply htop
tv:
----------
          ID: install htop
    Function: pkg.installed
        Name: htop
      Result: True
     Comment: The following packages were installed/updated: htop
     Started: <span class="m">15</span>:09:22.550836
    Duration: <span class="m">10969</span>.17 ms
     Changes:
              ----------
              htop:
                  ----------
                  new:
                      <span class="m">2</span>.2.0-2build1
                  old:

Summary <span class="k">for</span> tv
------------
Succeeded: <span class="m">1</span> <span class="o">(</span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="o">)</span>
Failed:    <span class="m">0</span>
------------
Total states run:     <span class="m">1</span>
</code></pre></div>

<p>Xem Ä‘áº§y Ä‘á»§ cÃ¡c option, cÃ¡c function khÃ¡c cá»§a <code>pkg state module</code> táº¡i <a href="https://docs.saltproject.io/en/latest/ref/states/all/salt.states.pkg.html#module-salt.states.pkg">module-salt.states.pkg</a></p>
<h3>Copy/render file vÃ  cháº¡y cÃ¢u lá»‡nh</h3>
<p>File <code>example.sls</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">render a config file</span><span class="p">:</span>
  <span class="nt">file.managed</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">source</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">salt://template.j2</span>
    <span class="p p-Indicator">-</span> <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jinja</span>
    <span class="p p-Indicator">-</span> <span class="nt">mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0400</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/ahihi.yml</span>

<span class="nt">now run a command</span><span class="p">:</span>
  <span class="nt">cmd.run</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cat /tmp/ahihi.yml | head</span>
</code></pre></div>

<p><code>cmd.run</code> dÃ¹ng Ä‘á»ƒ cháº¡y 1 cÃ¢u lá»‡nh trÃªn minion, lá»‡nh tÃ¹y Ã½. Vá»›i <code>cmd.run</code>,
ta Ä‘Ã£ cÃ³ thá»ƒ lÃ m Ä‘Æ°á»£c má»i thá»©, Ä‘Ã¢y lÃ  cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t Ä‘á»ƒ thay tháº¿ cÃ¡c
bash script máº·c dÃ¹ khÃ´ng pháº£i tá»‘i Æ°u nháº¥t. VÃ­ dá»¥: náº¿u cháº¡y apt-get install Ä‘á»ƒ
cÃ i package thay vÃ¬ pkg.installed sáº½ máº¥t Ä‘i cÃ¡c lá»£i Ã­ch pkg.installed thá»±c hiá»‡n
- cháº¡y trÃªn nhiá»u OS khÃ¡c nhau, tá»± Ä‘á»™ng cháº¡y apt update).
NgÆ°á»i má»›i táº­p dÃ¹ng Salt cÃ³ thá»ƒ dÃ¹ng <code>cmd.run</code> Ä‘á»ƒ báº¯t Ä‘áº§u, nhÆ°ng nÃªn tÃ¬m state
module cÃ³ sáºµn Ä‘á»ƒ thu Ä‘Æ°á»£c káº¿t quáº£ tá»‘t hÆ¡n.</p>
<p><code>file.managed</code> cÃ³ thá»ƒ táº£i 1 file tá»« internet, cÃ³ thá»ƒ copy 1 file tá»« X Ä‘áº¿n Y,
trong vÃ­ dá»¥ nÃ y nÃ³ copy file tá»« salt://template.j2 tá»›i minion rá»“i render vá»›i
<a href="https://docs.saltproject.io/en/getstarted/config/jinja.html">Jinja2 template</a>,
ghi vÃ o <code>/tmp/ahihi.yml</code> vÃ  chmod 0400.</p>
<p><code>salt://</code> trong vÃ­ dá»¥ nÃ y lÃ  <code>file_roots</code> trong file cáº¥u hÃ¬nh master, tá»©c thÆ°
má»¥c <code>/home/hvn/saltlab/states</code> trÃªn mÃ¡y master.</p>
<p>Ná»™i dung file template.j2:</p>
<div class="highlight"><pre><span></span><code><span class="cp">{%</span>- <span class="k">for</span> <span class="nv">i</span> <span class="k">in</span> <span class="o">[</span><span class="s1">&#39;meo&#39;</span><span class="o">,</span> <span class="s1">&#39;bo&#39;</span><span class="o">,</span> <span class="s1">&#39;ga&#39;</span><span class="o">]</span> <span class="cp">%}</span><span class="x"></span>
<span class="x">  - </span><span class="cp">{{</span> <span class="nv">i</span> <span class="cp">}}</span><span class="x"></span>
<span class="cp">{%</span>- <span class="k">endfor</span> <span class="cp">%}</span><span class="x"></span>

<span class="x">myuser: user</span>
<span class="x">mypassword: passwd</span>

<span class="x">os: </span><span class="cp">{{</span> <span class="nv">grains</span><span class="o">[</span><span class="s1">&#39;osfinger&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
<span class="x">ips: </span><span class="cp">{{</span> <span class="nv">grains</span><span class="o">[</span><span class="s1">&#39;ipv4&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="x"></span>
</code></pre></div>

<p>Jinja2 cÃ³ for if/else nhÆ° Python, xem
<a href="https://docs.saltproject.io/en/getstarted/config/jinja.html">Jinja2 template</a>
Ä‘á»ƒ tÃ¬m hiá»ƒu thÃªm.</p>
<h3>5 phÃºt dÃ nh cho lÃ½ thuyáº¿t: grains pillar</h3>
<p>1 nhÆ°á»£c Ä‘iá»ƒm cá»§a Salt lÃ  theo má»‘t thá»i 2010, Ä‘áº·t tÃªn cho má»i khÃ¡i niá»‡m, vÃ  tÃªn
Ä‘Ã³ khÃ´ng thá»±c sá»± cÃ³ nhiá»u Ã½ nghÄ©a - Ä‘Æ¡n giáº£n chá»‰ lÃ  bá»‹a ra (theo má»‘t cá»§a
<a href="https://www.chef.io/">Chef</a> - má»™t Ä‘á»‘i thá»§ viáº¿t báº±ng Ruby).</p>
<p>Salt cÃ³ 2 khÃ¡i niá»‡m:</p>
<ul>
<li>grains: chá»©a cÃ¡c thÃ´ng tin vá» mÃ¡y minion (OS, version, ip, ...)</li>
<li>pillar: chá»©a cÃ¡c thÃ´ng tin truyá»n tá»« master (thÆ°á»ng lÃ  cÃ¡c thÃ´ng tin bÃ­ máº­t nhÆ°
  user/password).</li>
</ul>
<h4>salt  grains</h4>
<p>VÃ­ dá»¥ trÃªn cÃ³ truy cáº­p 2 thÃ´ng tin tá»« grains lÃ  tÃªn há»‡ Ä‘iá»u hÃ nh vÃ  cÃ¡c IPv4 cá»§a
mÃ¡y minion. state.apply</p>
<div class="highlight"><pre><span></span><code>          <span class="nt">ID</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">render a config file</span>
   <span class=" -Error"> </span><span class="nt">Function</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">file.managed</span>
        <span class="l l-Scalar l-Scalar-Plain">Name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/ahihi.yml</span>
      <span class="l l-Scalar l-Scalar-Plain">Result</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
     <span class="l l-Scalar l-Scalar-Plain">Comment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">File /tmp/ahihi.yml is in the correct state</span>
     <span class="l l-Scalar l-Scalar-Plain">Started</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">19:33:25.337228</span>
    <span class="nt">Duration</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">34.549 ms</span>
     <span class="l l-Scalar l-Scalar-Plain">Changes</span><span class="p p-Indicator">:</span>
<span class="l l-Scalar l-Scalar-Plain">----------</span>
          <span class="l l-Scalar l-Scalar-Plain">ID</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">now run a command</span>
    <span class="l l-Scalar l-Scalar-Plain">Function</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cmd.run</span>
        <span class="l l-Scalar l-Scalar-Plain">Name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cat /tmp/ahihi.yml | head</span>
      <span class="l l-Scalar l-Scalar-Plain">Result</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
     <span class="l l-Scalar l-Scalar-Plain">Comment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Command &quot;cat /tmp/ahihi.yml | head&quot; run</span>
     <span class="l l-Scalar l-Scalar-Plain">Started</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">19:33:25.372408</span>
    <span class="l l-Scalar l-Scalar-Plain">Duration</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7.672 ms</span>
     <span class="l l-Scalar l-Scalar-Plain">Changes</span><span class="p p-Indicator">:</span>
              <span class="l l-Scalar l-Scalar-Plain">----------</span>
              <span class="l l-Scalar l-Scalar-Plain">pid</span><span class="p p-Indicator">:</span>
                  <span class="l l-Scalar l-Scalar-Plain">42905</span>
              <span class="nt">retcode</span><span class="p">:</span>
                  <span class="l l-Scalar l-Scalar-Plain">0</span>
              <span class="nt">stderr</span><span class="p">:</span>
              <span class="nt">stdout</span><span class="p">:</span>

                    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">meo</span>
                    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bo</span>
                    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ga</span>

              <span class=" -Error">    </span><span class="nt">myuser</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">user</span>
                  <span class="nt">mypassword</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">passwd</span>

                  <span class="nt">os</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Ubuntu-20.04</span>
                  <span class="nt">ips</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;192.168.0.110&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>

<p>Äá»ƒ liá»‡t kÃª táº¥t cáº£ grains cá»§a minion, dÃ¹ng Salt command <code>grains.items</code></p>
<div class="highlight"><pre><span></span><code>$ salt-ssh -c ~/saltlab tv grains.items
tv:
    ----------
    biosreleasedate:
        <span class="m">08</span>/27/2020
    biosversion:
        <span class="m">0416</span>
    cpu_flags:
    ...
</code></pre></div>

<h4>salt pillar</h4>
<p>Pillar chá»‰ náº±m trÃªn master, nÃ³ map file nÃ o dÃ nh cho minion nÃ o. File <code>top.sls</code></p>
<div class="highlight"><pre><span></span><code>base:
  &#39;*&#39;:
    - common
  &#39;trau&#39;:
    - uds
</code></pre></div>

<p><code>*</code> tá»©c má»i minion Ä‘á»u cÃ³ thá»ƒ truy cáº­p cÃ¡c pillar item trong file <code>common.sls</code>,
chá»‰ <code>trau</code> má»›i truy cáº­p Ä‘Æ°á»£c ná»™i dung trong file <code>uds.sls</code>.</p>
<p>CÃ¡c file pillar lÃ  cÃ¡c file <code>.sls</code> theo syntax YAML, biá»ƒu diá»…n cÃ¡c dictionary
cá»§a Python. VÃ­ dá»¥: <code>uds.sls</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">telegram_token</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">this_is_token</span>

<span class="nt">database</span><span class="p">:</span>
  <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">toor</span>
</code></pre></div>

<p>Äá»ƒ liá»‡t kÃª táº¥t cáº£ pillar item dÃ nh cho minion, dÃ¹ng Salt command <code>pillar.items</code>
(chÃº Ã½ grains cÃ³ s, pillar khÃ´ng cÃ³).</p>
<div class="highlight"><pre><span></span><code>$ salt-ssh -c ~/saltlab trau pillar.items
trau:
    ----------
    database:
        ----------
        password:
            toor
        username:
            root
    telegram_token:
        this_is_token
</code></pre></div>

<p>VÃ­ dá»¥ 1 file dÃ¹ng pillar:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># /lib/systemd/system/uds.service</span>
<span class="p p-Indicator">[</span><span class="nv">Unit</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">Description=UDS telegram bot</span>

<span class="l l-Scalar l-Scalar-Plain">[Service]</span>
<span class="l l-Scalar l-Scalar-Plain">User=uds</span>
<span class="l l-Scalar l-Scalar-Plain">Environment=BOT_TOKEN={{ pillar[&#39;telegram_token&#39;] }}</span>
</code></pre></div>

<h3>Deploy 1 Python project</h3>
<p>Link nÃ y viáº¿t 1 salt formula (tÃªn cá»§a 1 "bá»™ cÃ i báº±ng Salt") Ä‘á»ƒ cÃ i
bot telegram <code>uds</code> cháº¡y trÃªn Ubuntu 18.04 vá»›i systemd.
<a href="https://github.com/pymivn/udsbot-salt">udsbot-salt</a></p>
<h3>Troubleshooting</h3>
<p>Khi kÃªt quáº£ cháº¡y apply khÃ´ng thÃ nh cÃ´ng, thÃªm <code>-ldebug</code> Ä‘á»ƒ xem log chi tiáº¿t.</p>
<h2>DÃ¹ng Ansible "xá»‹n hÆ¡n" khÃ´ng?</h2>
<p>KhÃ´ng, Ansible giá»‘ng Salt Ä‘áº¿n báº¥t ngá», cÅ©ng viáº¿t báº±ng Python vá»›i cÃ¡c module
tÆ°Æ¡ng á»©ng, cÅ©ng dÃ¹ng Jinja2, cÅ©ng viáº¿t cáº¥u hÃ¬nh báº±ng file YAML.</p>
<p><a href="https://github.com/hvnsweeting/elbisna/blob/master/redis/roles/redis/tasks/main.yml">Xem vÃ­ dá»¥</a>.</p>
<p>NgÃ y nay, Ansible phá»• biáº¿n hÆ¡n nhá» nÃ³ Ä‘Æ¡n giáº£n hÆ¡n Ä‘á»ƒ báº¯t Ä‘áº§u, do Ã­t
tá»« khÃ³a hay khÃ¡i niá»‡m láº¡. NÄƒm 2015, RedHat mua láº¡i Ansible khiáº¿n cho nÃ³
cÃ ng trá»Ÿ nÃªn phá»• biáº¿n hÆ¡n.</p>
<p>Salt thÃ nh cÃ´ng trÆ°á»›c Ansible (2012 2013), Ä‘á»©ng sau lÃ  cÃ´ng ty SaltStack, Ä‘áº¿n
nÄƒm 2020 cÅ©ng Ä‘Æ°á»£c Ã´ng lá»›n <a href="https://www.vmware.com/support/acquisitions/saltstack.html">VMWare
mua láº¡i</a>. Salt cÃ³
nhiá»u Æ°u Ä‘iá»ƒm so vá»›i Ansible (Ä‘áº·c biá»‡t lÃ  nhanh),
cung cáº¥p nhiá»u tÃ­nh nÄƒng phá»©c táº¡p - dÃ¹ng trong mÃ´i trÆ°á»ng phá»©c táº¡p.</p>
<p>DÃ¹ng Salt chuyá»ƒn sang Ansible máº¥t ná»­a ngÃ y Ä‘á»ƒ map láº¡i khÃ¡i niá»‡m.</p>
<h2>Há»c salt lÃ  há»c gÃ¬</h2>
<p>Äa pháº§n lÃ  há»c cÃ¡c salt module (nhÆ° <code>pkg.installed</code>) cÃ³ sáºµn Ä‘á»ƒ viáº¿t cÃ¡c
state, dÃ¹ng chÃºng nhÆ° cÃ¡c viÃªn gáº¡ch Ä‘á»ƒ tá»± Ä‘á»™ng quÃ¡ trÃ¬nh cÃ i Ä‘áº·t / cáº¥u hÃ¬nh
pháº§n má»m trÃªn há»‡ thá»‘ng.
CÃ¡ch thá»±c hÃ nh Ä‘Æ¡n giáº£n nháº¥t lÃ  dÃ¹ng Salt cÃ i cÃ¡c pháº§n má»m trÃªn chÃ­nh mÃ¡y tÃ­nh
cá»§a mÃ¬nh Ä‘ang dÃ¹ng, thay vÃ¬ gá»i <code>salt-ssh</code>, dÃ¹ng</p>
<div class="highlight"><pre><span></span><code>sudo salt-call --local state.apply FORMULA_NAME -linfo
</code></pre></div>

<h2>HÃ nh Ä‘á»™ng cá»§a chÃºng ta</h2>
<p>Táº¡o 1 salt formula Ä‘á»ƒ deploy app Flask hello world cháº¡y báº±ng gunicorn
vá»›i NGINX server rá»“i táº¡o Pull Request vÃ o <a href="https://github.com/pymivn/flask-salt">pymivn/flask-salt</a>
Ä‘á»ƒ trÄƒm hay Ä‘á»u nhÆ° tay quen.</p>
<h2>Káº¿t luáº­n</h2>
<p>NÄƒm COVID-19 thá»© 2, 2021, Salt, Ansible, Chef hay Puppet khÃ´ng cÃ²n má»›i máº» gÃ¬,
tá»«ng lÃ  "Ä‘iá»ƒm cá»™ng" trong cÃ¡c vÃ²ng tuyá»ƒn dá»¥ng thÃ¬ giá» lÃ  yÃªu cáº§u hiá»ƒn nhiÃªn
cho giá»›i "DevOps", tháº¿ giá»›i cÅ©ng Ä‘Ã£ Ä‘u theo má»™t trend má»›i hÆ¡n, hot hÆ¡n
cÃ³ tÃªn Docker+Kubernetes, nhÆ°ng cÃ¡c CM váº«n luÃ´n cÃ³ Ä‘áº¥t dÃ¹ng. Trend lÃªn rá»“i sáº½
xuá»‘ng, hot rá»“i sáº½ nguá»™i, cÃ¡i gÃ¬ há»£p lÃ½ thÃ¬ ta dÃ¹ng.</p>
<p>Äáº¿n Ä‘Ã¢y, Ä‘Ã£ Ä‘á»§ Ä‘á»ƒ cÃ¡c Python dev deploy code nhÆ° 1 DevOps engineer thá»±c thá»¥,
khÃ´ng pháº£i nhá»c nháº±n code bash.</p>
<blockquote>
<p>Life's too short to remember how to write Bash code. I feel liberated.  â€” @laheadle on Clojurians Slack</p>
</blockquote>
<h2>References</h2>
<ul>
<li><a href="https://docs.saltproject.io/en/latest/topics/ssh/">salt-ssh</a></li>
<li>https://github.com/saltstack/salt/issues/59942</li>
<li><a href="https://www.familug.org/2015/06/saltstack-chao-muoi-em-la-ai.html">ChÃ o Muá»‘i, em lÃ  ai? </a></li>
<li>https://docs.saltproject.io/en/latest/contents.html</li>
<li>CÃ¡c formula cá»™ng Ä‘á»“ng <a href="https://github.com/saltstack-formulas">saltstack-formulas</a></li>
</ul>
<h3>á»¦ng há»™ tÃ¡c giáº£</h3>
<p>HVN at <a href="http://pymi.vn">http://pymi.vn</a> and <a href="https://www.familug.org">https://www.familug.org</a>.</p>
<ul>
<li><a href="https://www.familug.org/p/ung-ho.html">á»¦ng há»™ tÃ¡c giáº£ ğŸº</a></li>
</ul>
  </div>
  <!-- /.entry-content -->
</section>
<section class="container">
  <div class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'pymier';
      var disqus_identifier = 'article/salt/';
      var disqus_url = 'http://pp.pymi.vn/article/salt/';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//pymier.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </div>
</section>

    <section class="container footer">
      <footer>
        <address>
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="http://python.org">Python</a>.
        </address>
        <address>
          Há»c láº­p trÃ¬nh Python táº¡i <a href="https://pymi.vn/">Pymi.vn</a>
        </address>
      </footer>
    </section>
  </main>

<script type="text/javascript">
var images = document.getElementsByTagName("img");
var i;

for(i = 0; i < images.length; i++) {
  images[i].className += " centered";
}
</script>
</body>

</html>