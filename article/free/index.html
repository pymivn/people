<!DOCTYPE html>
<html lang="vi">

<head>
   <title> Python free variable  - The PyMiers</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="robots" content="" />
  <link rel="stylesheet" type="text/css" href="/theme/css/app.css">
<link rel="stylesheet" type="text/css" href="http://pp.pymi.vn/theme/css/pygment.css">
  <!--
  <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
  -->

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">    <meta name="author" content="Pymiers" />
  <meta name="description" content="" />    <link href="http://pp.pymi.vn/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The PyMiers Full Atom Feed" />         
  <meta name="tags" content="python" />
</head>

<body>
  <main class="wrapper">
    <section class="container">
      <header class='column'>
        <h1 class='title'><a href="http://pp.pymi.vn/">The PyMiers</a></h1>
      </header>

      <div class="section">
        <div class="row navbar">
          <div class="column nav-item is-active"><a href="http://pp.pymi.vn/category/trang-chu/">Trang chủ</a></div>
           <div class="column nav-item "><a href="http://pp.pymi.vn/pages/about/">About</a></div>
          <div class="column nav-item "><a href="http://pp.pymi.vn/pages/add/">Tạo bài viết</a></div>
          <div class="column nav-item "><a href="http://pp.pymi.vn/pages/rss/">RSS</a></div>
          <div class="column nav-item"><a href="/archives">Archives</a></div>
        </div>
      </div>
    </section>

<section class="container">
  <header>
    <h2 class="entry-title">
      <a href="http://pp.pymi.vn/article/free/" rel="bookmark"
         title="Permalink to Python free variable">Python free variable</a></h2>  
  </header>
  <footer class='center'>
    <time class="published" datetime="2021-06-07T00:00:00+07:00"> 07/06/2021 </time>
    <address class="vcard author">By
                    <a class="url fn" href="http://pp.pymi.vn/author/hvnsweeting/">hvnsweeting</a>
 in <a href="http://pp.pymi.vn/category/trang-chu/">Trang chủ</a>
                </address>     <em>Tags</em>:     <a href="http://pp.pymi.vn/tag/python/"><em>python</em></a>    </footer>
  <br>
  <div class="entry-content">
    <p>Python có 2 loại variable (biến): local, global, và free (đếm từ 0, tất nhiên).</p>
<p><img alt="free" src="https://images.unsplash.com/photo-1546672117-f83291ce87a9?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=MnwyMzI1MzN8MHwxfHJhbmRvbXx8fHx8fHx8fDE2MjMwNzQxNTI&amp;ixlib=rb-1.2.1&amp;q=80&amp;w=600"></p>
<h2>binding</h2>
<p><code>x = 42</code> trong Python đọc là bind name x tới object 42.
Tham khảo thêm tại bài <a href="https://pymi.vn/blog/call-by/">Python call by gì?</a></p>
<h2>3 loại variable trong Python</h2>
<h3>global variable</h3>
<p>Đoạn code sau</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
</code></pre></div>

<p><code>x</code> viết sát lề, gọi là global variable. Chạy đoạn code trên sẽ hiện ra
exception:</p>
<div class="highlight"><pre><span></span><code><span class="ne">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s1">&#39;x&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</code></pre></div>

<p>do code dùng x trước khi x được bind tới object 42.</p>
<h3>local variable</h3>
<p>Đoạn code tiếp theo, chạy sẽ thấy gì? Gợi ý: không phải NameError:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>

<span class="n">foo</span><span class="p">()</span>
</code></pre></div>

<p><code>x = 42</code> nằm trong 1 block (trong thân function hay class), gọi là local variable.
Trong 1 block, dùng 1 variable/name trước khi bind nó (tức là có bind, nhưng
bind sau khi dùng), exception sẽ xảy ra là</p>
<div class="highlight"><pre><span></span><code><span class="ne">UnboundLocalError</span><span class="p">:</span> <span class="n">local</span> <span class="n">variable</span> <span class="s1">&#39;x&#39;</span> <span class="n">referenced</span> <span class="n">before</span> <span class="n">assignment</span>
</code></pre></div>

<h3>free variable</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">foo</span><span class="p">()</span>
</code></pre></div>

<p>Xóa <code>x = 42</code> trong ví dụ phần local, ta chạy đoạn code này, lại thấy NameError.</p>
<div class="highlight"><pre><span></span><code><span class="ne">NameError</span><span class="p">:</span> <span class="n">name</span> <span class="s1">&#39;x&#39;</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">defined</span>
</code></pre></div>

<p>Lần này không xảy ra UnboundLocalError, do đoạn code không bind x = 42
trong thân function (block). <code>x</code> ở đây là một free variable.</p>
<p>Free variable hoạt động theo cách ... rất tự do. Khi không tìm thấy x trong
foo, Python sẽ đi tìm x ở global (bên ngoài function foo).</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">96</span>
<span class="n">foo</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre></div>

<p>Màn hình sẽ hiện ra <code>42</code>, <code>100</code> hay <code>96</code>?</p>
<p>Việc tính toán tên <code>x</code> có giá trị gì, được thực hiện khi function <strong>CHẠY</strong>.
Khi gọi <code>foo()</code> ở trên, x đã có giá trị là 96.</p>
<h2>Static analysis</h2>
<p>Việc dùng các công cụ (phần mềm/chương trình) để phân tích/tìm lỗi code bằng
cách đọc code (text) - mà không cần chạy code, gọi là static analysis.
Trong Python phổ biến các công cụ như <code>pep8</code>, <code>flake8</code>, <code>pylint</code>, <a href="https://pp.pymi.vn/article/mypy/"><code>mypy</code> cũng
có thể tính luôn</a>, hay các tính năng
tích hợp sẵn của IDE như Pycharm.</p>
<p><code>flake8</code> cơ bản giống <code>pep8</code> (tên mới là <code>pycodestyle</code>), thêm tính năng phát
hiện thư viện không dùng tới/ hay biến không tồn tại.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">math</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">foo</span><span class="p">()</span>
</code></pre></div>

<p>khi chạy <code>flake8</code> với file code, <code>flake8</code> sẽ phát hiện ra thư viện
<code>math</code> được import nhưng không dùng, tên <code>x</code> chưa được định nghĩa.</p>
<div class="highlight"><pre><span></span><code><span class="err">$</span> <span class="n">flake8</span> <span class="n">scope</span><span class="o">.</span><span class="n">py</span>
<span class="n">scope</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="n">F401</span> <span class="s1">&#39;math&#39;</span> <span class="n">imported</span> <span class="n">but</span> <span class="n">unused</span>
<span class="n">scope</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span> <span class="n">F821</span> <span class="n">undefined</span> <span class="n">name</span> <span class="s1">&#39;x&#39;</span>
<span class="n">scope</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span> <span class="n">F841</span> <span class="n">local</span> <span class="n">variable</span> <span class="s1">&#39;x&#39;</span> <span class="ow">is</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">but</span> <span class="n">never</span> <span class="n">used</span>
</code></pre></div>

<p><code>flake8</code> rất hữu ích khi dễ dàng phát hiện các lỗi đơn giản như gõ nhầm tên
biến hay dùng biến không tồn tại như trên.
Nhưng khi <code>x</code> là free variable, không công cụ nào của Python có thể phát hiện
ra lỗi này cho tới khi chạy mới thấy exception:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">n_pymi_vn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">n_pymi_vn</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</code></pre></div>

<p>Do <code>x</code> là free variable, các công cụ phải quét hết cả file code để tìm <code>x</code>,
và nó tìm thấy, nên tin rằng <code>x</code> có tồn tại, nhưng đã quá muộn rồi.
Một ví dụ vô lý hơn nữa, để thấy sự bất lực của các công cụ static analysis:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">n_pymi_vn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">if</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">n_pymi_vn</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</code></pre></div>

<h2>Hành động của chúng ta</h2>
<p>Hạn chế hết mức việc sử dụng global variable, free variable, cần biến gì thì
đưa argument vào function biến đó, code "sát tường" cho hết vào 1 function
main và gọi main() nếu cần chạy.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">n_pymi_vn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">n_pymi_vn</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p><code>flake8</code> sẽ làm tốt nhiệm vụ phát hiện ra <code>x</code> chưa được định nghĩa trong ví dụ trên:
<code>F821 undefined name 'x'</code>, và đoạn code này có thể viết lại để không
còn dùng global/free variable nữa:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">n_pymi_vn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">n_pymi_vn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h2>Kết luận</h2>
<p>Tính dynamic của Python khiến các công cụ khó có thể xử lý mọi trường hợp,
công cụ sẽ chỉ giúp một phần, phần còn lại là sự cẩn thận của lập trình viên.</p>
<p>Tự do phải chăng cần trong khuôn khổ?</p>
<h2>Tham khảo</h2>
<ul>
<li><a href="https://www.familug.org/p/ung-ho.html">Ủng hộ tác giả 🍺</a></li>
<li><a href="https://docs.python.org/3/reference/executionmodel.html#interaction-with-dynamic-features">https://docs.python.org/3/reference/executionmodel.html#interaction-with-dynamic-features</a></li>
</ul>
  </div>
  <!-- /.entry-content -->
</section>
<section class="container">
  <div class="comments">
    <h3>Comments</h3>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'pymier';
      var disqus_identifier = 'article/free/';
      var disqus_url = 'http://pp.pymi.vn/article/free/';
      (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//pymier.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </div>
</section>

    <section class="container footer">
      <footer>
        <address>
        Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
        which takes great advantage of <a href="http://python.org">Python</a>.
        </address>
        <address>
          Học lập trình Python tại <a href="https://pymi.vn/">Pymi.vn</a>
        </address>
      </footer>
    </section>
  </main>

<script type="text/javascript">
var images = document.getElementsByTagName("img");
var i;

for(i = 0; i < images.length; i++) {
  images[i].className += " centered";
}
</script>
</body>

</html>